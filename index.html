<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FengWei Pai é”‹å‘³æ´¾ç¾é£Ÿå›¢è´­ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/icon3.jpg">
    <style>
        @keyframes slide-in-down { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-in-down { animation: slide-in-down 0.3s ease-out forwards; }
        @keyframes slide-in-right { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-slide-in-right { animation: slide-in-right 0.3s ease-out forwards; }
        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .toggle-checkbox:checked { right: 0; border-color: #48bb78; }
        .toggle-checkbox:checked + .toggle-label { background-color: #48bb78; }
        .hover-scale { transition: transform 0.2s ease-in-out; }
        .hover-scale:hover { transform: scale(1.02); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .card-shadow:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .gradient-bg { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        
        /* ç»Ÿä¸€æŒ‰é’®æ ·å¼ - ä¸»è¦æŒ‰é’® */
        .btn-primary { background: #dc2626; color: white; font-weight: 700; border-radius: 0.5rem; transition: background-color 0.2s; padding: 0.75rem 1rem; border: none; cursor: pointer; }
        .btn-primary:hover { background: #b91c1c; }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .btn-secondary { background: #d1d5db; color: #374151; font-weight: 500; border-radius: 0.5rem; transition: background-color 0.2s; padding: 0.5rem 1rem; border: none; cursor: pointer; }
        .btn-secondary:hover { background: #9ca3af; }
        
        .btn-success { background: #16a34a; color: white; font-weight: 500; border-radius: 0.5rem; transition: background-color 0.2s; padding: 0.5rem 1rem; border: none; cursor: pointer; }
        .btn-success:hover { background: #15803d; }
        
        .btn-danger { background: #ef4444; color: white; font-weight: 500; border-radius: 0.5rem; transition: background-color 0.2s; padding: 0.5rem 1rem; border: none; cursor: pointer; }
        .btn-danger:hover { background: #dc2626; }
        
        .btn-outline { background: transparent; color: #374151; font-weight: 500; border-radius: 0.5rem; transition: all 0.2s; padding: 0.5rem 1rem; border: 1px solid #d1d5db; cursor: pointer; }
        .btn-outline:hover { background: #f9fafb; }
        
        /* ç»Ÿä¸€è¾“å…¥æ¡†æ ·å¼ */
        .input-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.2s; }
        .input-field:focus { outline: none; border-color: #dc2626; box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }
        
        /* ç»Ÿä¸€æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background: white; border-radius: 0.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 32rem; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid #e5e7eb; }
        .modal-body { flex: 1; overflow-y: auto; padding: 1.25rem; }
        .modal-footer { padding: 1.25rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.75rem; }
        
        /* å…¨å±€å­—ä½“å¢å¼ºæ ·å¼ */
        * { font-weight: 600 !important; }
        body { font-size: 16px !important; font-weight: 600 !important; }
        h1 { font-size: 24px !important; font-weight: 700 !important; }
        h2 { font-size: 22px !important; font-weight: 700 !important; }
        h3 { font-size: 20px !important; font-weight: 700 !important; }
        h4 { font-size: 18px !important; font-weight: 700 !important; }
        table th { font-size: 16px !important; font-weight: 700 !important; }
        table td { font-size: 15px !important; font-weight: 600 !important; }
        button { font-size: 15px !important; font-weight: 700 !important; }
        input { font-size: 15px !important; font-weight: 600 !important; }
        select { font-size: 15px !important; font-weight: 600 !important; }
        .text-sm { font-size: 15px !important; font-weight: 600 !important; }
        .text-xs { font-size: 13px !important; font-weight: 600 !important; }
        label { font-weight: 700 !important; }
        span { font-weight: 600 !important; }
        div { font-weight: 600 !important; }
        p { font-weight: 600 !important; }
        a { font-weight: 600 !important; }
        .font-bold { font-weight: 800 !important; }
        .font-semibold { font-weight: 700 !important; }
        .font-medium { font-weight: 700 !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script type="text/babel">
      // Chromeå…¼å®¹æ€§æ£€æŸ¥
      if (typeof window.supabase === 'undefined') {
          console.error('Supabase not loaded. Please refresh the page.');
          document.body.innerHTML = '<div style="padding:20px;color:red;font-size:18px;">æ­£åœ¨åŠ è½½å¿…è¦èµ„æºï¼Œè¯·åˆ·æ–°é¡µé¢...</div>';
      }
      
      // è¿ç§»è‡ª index.html çš„å…¨éƒ¨ React ç»„ä»¶å’ŒåŠŸèƒ½
// 1. Supabase é…ç½®ä¸å¸¸é‡
const SUPABASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZm5oaHRoenRza3V1b3N1YXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTYxMTYsImV4cCI6MjA2NTU3MjExNn0.O3g2gjvsWagmWgmzoeJA8mPampvLYJr-KgqVwXsKoAo';
const WHATSAPP_NUMBER = '60162327792';
const ADMIN_PASSWORD = 'fengweipaiadmin';
const SELF_PICKUP_ADDRESS = `667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.`;
const PRODUCT_IMAGE_BASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/';
// é¿å…ä¸å…¨å±€ supabase UMD å¯¹è±¡åŒåé®è”½ï¼Œæ˜¾å¼å¼•ç”¨ window.supabase
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// ä¸ºäº†å‘åå…¼å®¹ï¼Œä¹Ÿåˆ›å»º supabase åˆ«å
const supabase = supabaseClient;
// è§£æ„ React Hooks ä¾›åç»­ç›´æ¥ä½¿ç”¨
const { useState, useEffect, useCallback, useRef, useMemo } = React;

// Chromeå…¼å®¹æ€§å¢å¼ºï¼šæ·»åŠ é”™è¯¯è¾¹ç•Œ
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }
  
  componentDidCatch(error, errorInfo) {
    console.error('React Error:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return React.createElement('div', {
        style: { padding: '20px', color: 'red', fontSize: '18px' }
      }, 'åº”ç”¨é‡åˆ°é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚é”™è¯¯ä¿¡æ¯: ' + (this.state.error?.message || 'æœªçŸ¥é”™è¯¯'));
    }
    return this.props.children;
  }
}

// ===== é€šç”¨å·¥å…·å‡½æ•° =====
function buildOrderMessage(order){
  try {
    let msg = `ğŸ›ï¸ *é”‹å‘³æ´¾æ–°è®¢å• #${order.order_id}*\n\n`;
    msg += `ğŸ‘¤ *å®¢æˆ·ä¿¡æ¯*\nğŸ“› å§“å: ${order.name}\nğŸ“± ç”µè¯: ${order.phone}\nğŸšš å–è´§æ–¹å¼: ${order.delivery_method==='self-pickup'?'è‡ªå–':'Lalamoveé€è´§'}\n`;
    if (order.delivery_method === 'self-pickup') {
      msg += `ğŸ“ è‡ªå–åœ°å€: ${SELF_PICKUP_ADDRESS}\n`;
    }
    msg += `\nğŸ›’ *è®¢å•æ˜ç»†*\n`;
    (order.order_items||[]).forEach(it=>{
      const n=it.product||''; let emoji=it.emoji;
      if(!emoji){ if(n.includes('çƒ¤è‚ ')) emoji='ğŸŒ­'; else if(n.includes('è™¾')) emoji='ğŸ¦'; else if(n.includes('æŠ«è¨')) emoji='ğŸ•'; else if(n.includes('æ±¤åŒ…')) emoji='ğŸ¥Ÿ'; else if(n.includes('é…¥')) emoji='ğŸ¥®'; else if(n.includes('é¸¡')) emoji='ğŸ—'; else emoji='â–«ï¸'; }
      msg += `${emoji} ${it.product}${it.is_unlimited?' (é¢„è´­)':' (ç°è´§)'} Ã— ${it.quantity} = RM${(it.quantity*it.price).toFixed(2)}\n`;
    });
    msg += `\nğŸ’° *æ€»é‡‘é¢: RM${Number(order.total_amount).toFixed(2)}*\nğŸ“ *å¤‡æ³¨*: ${order.remarks||'æ— '}\n`;
    msg += `ğŸ“… *ä¸‹å•æ—¶é—´*: ${(order.created_at? new Date(order.created_at):new Date()).toLocaleString('zh-CN')}`;
    return msg;
  } catch { return 'è®¢å•ä¿¡æ¯ç”Ÿæˆå¤±è´¥'; }
}
async function copyTextUniversal(text){
  try{ 
    if(navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function'){ 
      await navigator.clipboard.writeText(text); 
      return true; 
    } 
  }catch{}
  try{ const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.top='-2000px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true;}catch{return false;}
}
function printOrder(order){
  const w=window.open('','_blank','width=820,height=900'); 
  if(!w){ alert('è¯·å…è®¸å¼¹çª—'); return;}
  const doc = w.document;
  doc.open();
  doc.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>è®¢å• ' + order.order_id + '</title>');
  doc.write('<style>body{font-family:Arial,system-ui;margin:16px;font-size:16px;font-weight:bold;}h1{font-size:28px;margin:0 0 12px;font-weight:bold;}div{font-size:16px;margin:6px 0;font-weight:bold;}table{width:100%;border-collapse:collapse;margin-top:12px;}th,td{border:2px solid #333;padding:8px;font-size:16px;font-weight:bold;}th{background:#f5f5f5;font-size:18px;} .total{font-weight:700;text-align:right;margin-top:12px;}@media print{@page{margin:10mm;}button{display:none}} .checkbox{width:20px;height:20px;border:3px solid #333;display:inline-block;margin-left:10px;}</style></head><body>');
  doc.write('<h1>é”‹å‘³æ´¾è®¢å• #' + order.order_id + '</h1>');
  doc.write('<div>å®¢æˆ·: ' + order.name + ' (' + order.phone + ')</div>');
  doc.write('<div>æ–¹å¼: ' + (order.delivery_method==='self-pickup'?'è‡ªå–':'Lalamoveé€è´§') + '</div>');
  doc.write('<div>å¤‡æ³¨: ' + (order.remarks||'æ— ') + '</div>');
  doc.write('<table><thead><tr><th>å•†å“</th><th style="width:120px;">æ•°é‡ & å·²æ‰“åŒ…</th></tr></thead><tbody>');
  (order.order_items||[]).forEach(function(i){
    doc.write('<tr><td>' + i.product + '</td><td style="text-align:center;">' + i.quantity + '<span class="checkbox"></span></td></tr>');
  });
  doc.write('</tbody></table>');
  doc.write('<div style="margin-top:16px; border-top:2px solid #333; padding-top:10px; font-size:14px; color:#666; font-weight:bold;">æ‰“åŒ…å®Œæˆåè¯·åœ¨æ•°é‡æ—è¾¹çš„å‹¾é€‰æ¡†å†…æ‰“å‹¾ âœ“</div>');
  doc.write('<button onclick="window.print()" style="font-size:16px;font-weight:bold;padding:10px 20px;margin-top:16px;">æ‰“å°</button></body></html>');
  doc.close();
}

// ===== åŸºç¡€ UI ç»„ä»¶ =====
function LoadingSpinner({text}){ return (<div style={{textAlign:'center',padding:'16px'}}><svg style={{height:'40px',width:'40px',color:'#dc2626',animation:'spin 1s linear infinite'}} viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" opacity="0.25"/><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" opacity="0.75"/></svg>{text&&<div style={{marginTop:'8px',fontSize:'14px',color:'#555'}}>{text}</div>}</div>); }
function Toast({message,type='success',onDismiss}){ useEffect(()=>{ const t=setTimeout(()=>onDismiss&&onDismiss(),2500); return()=>clearTimeout(t);},[onDismiss]); const colors={success:'#16a34a',danger:'#dc2626',warning:'#d97706'}; return <div style={{background:'#fff',border:'1px solid #e5e7eb',padding:'8px 12px',borderRadius:'8px',color:colors[type]||'#374151',boxShadow:'0 2px 6px rgba(0,0,0,0.08)',fontSize:'14px'}}>{message}</div>; }


      function LoginScreen({ onLogin }) {
        const [password, setPassword] = React.useState('');
        const [showPassword, setShowPassword] = React.useState(false);
        const [error, setError] = React.useState('');
        
        const handleSubmit = e => {
          e.preventDefault();
          if (password === 'fengweipaiadmin') {
            onLogin();
          } else {
            setError('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
          }
        };
        
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
              <div className="text-center mb-6">
                <i className="fas fa-utensils text-4xl text-red-600 mb-4"></i>
                <h1 className="text-2xl font-bold text-gray-800">FengWei Pai ç®¡ç†åå°</h1>
                <p className="text-gray-600 mt-2">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </p>
              </div>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†å‘˜å¯†ç </label>
                  <div className="relative">
                    <input 
                      type={showPassword ? "text" : "password"}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                      value={password} 
                      onChange={e => setPassword(e.target.value)} 
                      required 
                    />
                    <button
                      type="button"
                      className="absolute inset-y-0 right-0 pr-3 flex items-center"
                      onClick={() => setShowPassword(!showPassword)}
                    >
                      <i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-gray-400 hover:text-gray-600`}></i>
                    </button>
                  </div>
                </div>
                <button 
                  type="submit" 
                  className="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors font-medium"
                >
                  ç™»å½•
                </button>
                {error && <div className="text-red-600 text-sm text-center mt-2">{error}</div>}
              </form>
            </div>
          </div>
        );
      }

      // Rename for consistency
      const Login = LoginScreen;

                    // === å®¢æˆ·ç«¯è´­ç‰©ç»„ä»¶ ===
              const CustomerView = ({ products, cart, addToCart, updateCartQuantity, removeFromCart, cartTotal, totalItems, showToast, refreshProducts, isLoading, setLastOrder, setCart, onAdminClick }) => {
                const [isCartOpen, setIsCartOpen] = useState(false);
                const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
                const [isConfirmOpen, setIsConfirmOpen] = useState(false);
                const [orderData, setOrderData] = useState(null);
                
                // Updated categories to match product series
                const categories = useMemo(() => ['ğŸ½ï¸ å…¨éƒ¨å•†å“', 'ğŸŒ­ çƒ¤è‚ ç³»åˆ—', 'ğŸ¥Ÿ çƒ§å–ç³»åˆ—', 'ğŸ¥Ÿ æ°´é¥ºç³»åˆ—', 'ğŸŸ é±¼ä¸¸ç³»åˆ—', 'ğŸœ é¢é£Ÿç³»åˆ—', 'ğŸš é¥­ç±»ç³»åˆ—', 'ğŸ² æ±¤å“ç³»åˆ—', 'ğŸ¥¤ é¥®æ–™ç³»åˆ—'], []);
                const [activeCategory, setActiveCategory] = useState('ğŸ½ï¸ å…¨éƒ¨å•†å“');
                
                const filteredProducts = useMemo(() => {
                  if (activeCategory === 'ğŸ½ï¸ å…¨éƒ¨å•†å“') return products;
                  const categoryName = activeCategory.replace(/^[ğŸ½ï¸ğŸŒ­ğŸ¥ŸğŸŸğŸœğŸšğŸ²ğŸ¥¤]\s/, ''); // Remove emoji prefix
                  return products.filter(p => p.category === categoryName);
                }, [products, activeCategory]);
                
                const handleOrderSuccess = (finalOrder) => {
                  if (typeof setCart === 'function') setCart([]);
                  setIsConfirmOpen(false);
                  setIsCheckoutOpen(false);
                  setLastOrder(finalOrder);
                  refreshProducts();
                };
                
                return (
                  <div>
                    <header className="bg-white shadow-md sticky top-0 z-40">
                      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between items-center py-4">
                          <div className="flex items-center gap-3">
                            <i className="fas fa-utensils text-3xl text-red-600"></i>
                            <h1 className="text-2xl font-bold text-gray-800">é”‹å‘³æ´¾ç¾é£Ÿå›¢è´­</h1>
                          </div>
                          <button onClick={onAdminClick} className="text-gray-600 hover:text-red-600 transition-all duration-200 group">
                            <div className="flex flex-col items-center">
                              <i className="fas fa-user-shield text-2xl group-hover:scale-110 transition-transform"></i>
                              <span className="text-xs mt-1 opacity-75 group-hover:opacity-100">ç®¡ç†</span>
                            </div>
                          </button>
                        </div>
                      </div>
                    </header>
                    
                    {/* Category Navigation */}
                    <div className="bg-white shadow-sm border-b sticky top-[88px] z-30">
                      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex space-x-4 py-3 overflow-x-auto">
                          {categories.map(category => (
                            <button
                              key={category}
                              onClick={() => setActiveCategory(category)}
                              className={`px-4 py-2 rounded-full font-medium transition-colors whitespace-nowrap ${
                                activeCategory === category
                                  ? 'bg-red-600 text-white'
                                  : 'bg-gray-100 text-gray-700 hover:bg-red-100'
                              }`}
                            >
                              {category}
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                    
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-20">
                        {isLoading ? (
                          <p className="col-span-full text-center text-gray-500">åŠ è½½ä¸­...</p>
                        ) : products.length === 0 ? (
                          <p className="col-span-full text-center text-gray-500">æš‚æ— å•†å“ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ ã€‚</p>
                        ) : filteredProducts.length > 0 ? (
                          filteredProducts.map(product => (
                            <ProductCard key={product.id} product={product} onAddToCart={addToCart} />
                          ))
                        ) : (
                          <p className="col-span-full text-center text-gray-500">è¯¥åˆ†ç±»ä¸‹æš‚æ— å•†å“ã€‚</p>
                        )}
                      </div>
                      
                      {cart.length > 0 && (
                        <div className="fixed bottom-6 right-6 z-40">
                          <button 
                            onClick={() => { 
                              setIsCartOpen(true); 
                            }} 
                            className="gradient-bg text-white rounded-full p-4 shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-110 flex items-center gap-3 group"
                          >
                            <div className="relative">
                              <i className="fas fa-shopping-cart text-2xl group-hover:animate-bounce"></i>
                              <span className="absolute -top-2 -right-2 bg-yellow-400 text-black text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center animate-pulse">
                                {totalItems}
                              </span>
                            </div>
                            <div className="flex flex-col">
                              <span className="font-bold text-lg">RM{cartTotal.toFixed(2)}</span>
                              <span className="text-xs opacity-90">{totalItems} ä»¶å•†å“</span>
                            </div>
                          </button>
                        </div>
                      )}
                      
                      <CartSidebar 
                        isOpen={isCartOpen}
                        cart={cart} 
                        updateQuantity={updateCartQuantity}
                        removeFromCart={removeFromCart}
                        totalPrice={cartTotal}
                        totalItems={totalItems}
                        onClose={() => setIsCartOpen(false)} 
                        onCheckout={() => { 
                          setIsCartOpen(false); 
                          setIsCheckoutOpen(true); 
                        }} 
                      />
                      
                      {isCheckoutOpen && <CheckoutModal cart={cart} total={cartTotal} onClose={() => setIsCheckoutOpen(false)} onConfirm={(data) => { setOrderData(data); setIsCheckoutOpen(false); setIsConfirmOpen(true); }} showToast={showToast} />}
                      {isConfirmOpen && <ConfirmationModal orderData={orderData} onConfirm={handleOrderSuccess} onCancel={() => { setIsConfirmOpen(false); setIsCheckoutOpen(true); }} showToast={showToast} />}
                    </div>
                  </div>
                );
              };


              const ProductCard = ({ product, onAddToCart }) => {
                const isOutOfStock = !product.is_unlimited && product.stock === 0;
                const isLowStock = !product.is_unlimited && product.stock > 0 && product.minStock && product.stock <= product.minStock;
                const productTypeLabel = product.is_unlimited ? '(é¢„è´­)' : '(ç°è´§)';
                return (
                  <div className={`bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 flex flex-col overflow-hidden hover-scale card-shadow ${isOutOfStock ? 'opacity-60 grayscale' : ''}`}>
                    <div className="relative">
                      <div className="w-full h-52 bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center overflow-hidden">
                        {product.image ? (
                          <img 
                            src={product.image} 
                            alt={product.name} 
                            className="w-full h-full object-cover hover:scale-110 transition-transform duration-300"
                            onError={(e) => {
                              e.target.style.display = 'none';
                              e.target.nextSibling.style.display = 'flex';
                            }}
                          />
                        ) : null}
                        <div className="w-full h-full flex items-center justify-center text-6xl bg-gradient-to-br from-red-50 to-red-100" style={{ display: product.image ? 'none' : 'flex' }}>
                          {product.emoji || 'ğŸ½ï¸'}
                        </div>
                      </div>
                      {isOutOfStock && (
                        <div className="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center backdrop-blur-sm">
                          <div className="text-center">
                            <i className="fas fa-times-circle text-white text-3xl mb-2"></i>
                            <span className="text-white font-bold text-lg">å·²å”®å®Œ</span>
                          </div>
                        </div>
                      )}
                      {isLowStock && !isOutOfStock && (
                        <div className="absolute top-3 left-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg animate-pulse">
                          <i className="fas fa-exclamation-triangle mr-1"></i>ä½åº“å­˜
                        </div>
                      )}
                      {product.is_unlimited && (
                        <div className="absolute top-3 right-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">
                          <i className="fas fa-infinity mr-1"></i>é¢„è´­
                        </div>
                      )}
                    </div>
                    <div className="p-5 flex flex-col flex-grow">
                      <div className="mb-3">
                        <h3 className="text-lg font-bold text-gray-800 mb-1 line-clamp-2">{product.name}</h3>
                        <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{productTypeLabel}</span>
                      </div>
                      <div className="mb-4">
                        <div className="flex items-center justify-between text-sm text-gray-600">
                          <span className="flex items-center">
                            <i className="fas fa-warehouse mr-2 text-gray-400"></i>
                            åº“å­˜: {product.is_unlimited ? 'å……è¶³' : product.stock}
                          </span>
                          {product.category && (
                            <span className="bg-red-50 text-red-600 px-2 py-1 rounded text-xs">
                              {product.category}
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="mt-auto">
                        <div className="flex justify-between items-center">
                          <div>
                            <p className="text-2xl font-bold text-red-600 flex items-center">
                              RM{Number(product.price).toFixed(2)}
                              <span className="text-xs text-gray-500 ml-1">/ä»¶</span>
                            </p>
                          </div>
                          <button
                            onClick={() => onAddToCart(product)}
                            disabled={isOutOfStock}
                            className={`font-bold py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center gap-2 shadow-md ${
                              isOutOfStock 
                                ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                : 'bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white hover:shadow-lg transform hover:-translate-y-0.5'
                            }`}
                          >
                            <i className={`fas ${isOutOfStock ? 'fa-times' : 'fa-cart-plus'}`}></i>
                            {isOutOfStock ? 'å”®ç½„' : 'æ·»åŠ '}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              };

              const CartSidebar = ({ isOpen, cart, updateQuantity, removeFromCart, totalPrice, totalItems, onClose, onCheckout }) => {
                const handleQuantityChange = (item, newQuantity) => {
                  updateQuantity(item.id, newQuantity);
                };
                return (
                  <div>
                    <div
                      className={`fixed inset-0 bg-black/60 z-40 transition-opacity duration-300 ${
                        isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'
                      }`}
                      onClick={onClose}
                    />
                    <div
                      className={`fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-xl z-50 transform transition-transform duration-300 ${
                        isOpen ? 'translate-x-0' : 'translate-x-full'
                      } flex flex-col`}
                    >
                      <header className="flex items-center justify-between p-5 border-b">
                        <h2 className="text-xl font-bold text-gray-800">è´­ç‰©è½¦</h2>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-800">
                          <i className="fas fa-times text-2xl"></i>
                        </button>
                      </header>
                      <div className="flex-1 overflow-y-auto p-5">
                        {cart.length === 0 ? (
                          <div className="text-center text-gray-500 mt-20">
                            <i className="fas fa-shopping-cart text-4xl mb-4"></i>
                            <p>è´­ç‰©è½¦ä¸ºç©º</p>
                          </div>
                        ) : (
                          <div className="space-y-4">
                            {cart.map(item => (
                              <div key={item.id} className="bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                                <div className="flex items-center gap-4">
                                  <div className="text-3xl flex-shrink-0">{item.emoji || 'ğŸ½ï¸'}</div>
                                  <div className="flex-1 min-w-0">
                                    <h3 className="font-medium text-gray-800 truncate">{item.name}</h3>
                                    <div className="flex items-center gap-2">
                                      <p className="text-red-600 font-bold">RM{Number(item.price).toFixed(2)}</p>
                                      <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                        {item.is_unlimited ? 'é¢„è´­' : 'ç°è´§'}
                                      </span>
                                      {!item.is_unlimited && (
                                        <span className="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                          åº“å­˜: {item.stock_quantity || 0}
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                  <div className="flex flex-col items-end gap-2">
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={() => handleQuantityChange(item, item.quantity - 1)}
                                        className="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 hover:text-red-600 transition-colors"
                                      >
                                        <i className="fas fa-minus text-xs"></i>
                                      </button>
                                      <span className="w-8 text-center font-medium text-gray-800">{item.quantity}</span>
                                      <button
                                        onClick={() => handleQuantityChange(item, item.quantity + 1)}
                                        disabled={!item.is_unlimited && item.quantity >= (item.stock_quantity || 0)}
                                        className={`w-8 h-8 rounded-full flex items-center justify-center text-xs transition-colors ${
                                          !item.is_unlimited && item.quantity >= (item.stock_quantity || 0)
                                            ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                            : 'bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-red-600'
                                        }`}
                                      >
                                        <i className="fas fa-plus"></i>
                                      </button>
                                    </div>
                                    <button
                                      onClick={() => removeFromCart(item.id)}
                                      className="text-xs text-gray-400 hover:text-red-500 transition-colors"
                                    >
                                      <i className="fas fa-trash mr-1"></i>åˆ é™¤
                                    </button>
                                  </div>
                                </div>
                                <div className="mt-2 pt-2 border-t border-gray-100">
                                  <div className="flex justify-between items-center text-sm">
                                    <span className="text-gray-500">å°è®¡</span>
                                    <span className="font-bold text-gray-800">RM{(item.quantity * item.price).toFixed(2)}</span>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                      {cart.length > 0 && (
                        <footer className="border-t p-5 bg-white">
                          <div className="space-y-4">
                            <div className="flex justify-between items-center">
                              <span className="text-gray-600">å•†å“æ€»æ•°:</span>
                              <span className="font-medium">{totalItems} ä»¶</span>
                            </div>
                            <div className="flex justify-between items-center text-lg">
                              <span className="font-medium text-gray-800">æ€»è®¡:</span>
                              <span className="text-2xl font-bold text-red-600">RM{totalPrice.toFixed(2)}</span>
                            </div>
                            <button
                              onClick={onCheckout}
                              className="w-full gradient-bg text-white font-bold py-4 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center gap-2"
                            >
                              <i className="fas fa-credit-card"></i>
                              ç«‹å³ç»“è´¦
                            </button>
                          </div>
                        </footer>
                      )}
                    </div>
                  </div>
                );
              };


              const CheckoutModal = ({ cart, total, onClose, onConfirm, showToast }) => {
                const [formData, setFormData] = useState({ 
                  name: '', 
                  phone: '', 
                  delivery: '', 
                  pickupAddress: '',
                  deliveryAddress: '',
                  remarks: '', 
                  paymentMethod: '' 
                });
                const [paymentProof, setPaymentProof] = useState(null);
                const [fileName, setFileName] = useState('');
                const [errors, setErrors] = useState({});
                const [agree, setAgree] = useState(false);
                
                const validate = () => {
                  const newErrors = {};
                  if (!agree) newErrors.agree = 'è¯·é˜…è¯»å¹¶åŒæ„æ¡æ¬¾';
                  if (!formData.name) newErrors.name = 'è¯·è¾“å…¥å§“å';
                  if (!formData.phone || !/^(\+?6?01)[0-46-9]-?[0-9]{7,8}$/.test(formData.phone)) newErrors.phone = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç”µè¯å·ç ';
                  if (!formData.delivery) newErrors.delivery = 'è¯·é€‰æ‹©å–è´§æ–¹å¼';
                  if (!formData.paymentMethod) newErrors.paymentMethod = 'è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼';
                  
                  // Self-pickup address is automatically set, no validation needed
                  
                  // Lalamove delivery requires address in deliveryAddress field
                  if (formData.delivery === 'lalamove' && (!formData.deliveryAddress || formData.deliveryAddress.trim() === '')) {
                    newErrors.deliveryAddress = 'Lalamoveé…é€æ—¶é…é€åœ°å€ä¸èƒ½ä¸ºç©º';
                  }
                  
                  if ((formData.paymentMethod === 'Maybank QR' || formData.paymentMethod === 'TNG eWallet') && !paymentProof) {
                    newErrors.paymentProof = 'è¯·ä¸Šä¼ æ”¯ä»˜å‡­è¯';
                  }
                  
                  setErrors(newErrors);
                  return Object.keys(newErrors).length === 0;
                };
                
                const handleChange = (e) => {
                  const { name, value } = e.target;
                  setFormData(prev => ({ ...prev, [name]: value }));
                  if (errors[name]) setErrors(prev => ({ ...prev, [name]: null }));
                };
                
                const handleFileChange = (e) => {
                  const file = e.target.files[0];
                  if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                      showToast('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'danger');
                      return;
                    }
                    setPaymentProof(file);
                    setFileName(file.name);
                    if (errors.paymentProof) setErrors(prev => ({ ...prev, paymentProof: null }));
                  }
                };
                
                const handleNextStep = (e) => {
                  e.preventDefault();
                  if (validate()) {
                    // Include pickup address in the final data
                    const finalData = { 
                      ...formData, 
                      paymentProof, 
                      cart, 
                      total,
                      pickup_address: formData.delivery === 'self-pickup' ? SELF_PICKUP_ADDRESS : null
                    };
                    onConfirm(finalData);
                  }
                };
                
                return (
                  <div className="modal-overlay">
                    <div className="modal-content max-w-2xl">
                      <div className="modal-header">
                        <h2 className="text-xl font-bold">ç»“è´¦</h2>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                      </div>
                      <div className="modal-body">
                        <form onSubmit={handleNextStep} className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">å§“å *</label>
                            <input type="text" name="name" value={formData.name} onChange={handleChange} className="input-field" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" />
                            {errors.name && <p className="text-red-500 text-xs mt-1">{errors.name}</p>}
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ç”µè¯å·ç  *</label>
                            <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className="input-field" placeholder="ä¾‹å¦‚: 0123456789" />
                            {errors.phone && <p className="text-red-500 text-xs mt-1">{errors.phone}</p>}
                          </div>
                          
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">å–è´§æ–¹å¼ *</label>
                            <select name="delivery" value={formData.delivery} onChange={handleChange} className="input-field">
                              <option value="">è¯·é€‰æ‹©å–è´§æ–¹å¼</option>
                              <option value="self-pickup">è‡ªå–</option>
                              <option value="lalamove">Lalamoveé€è´§</option>
                            </select>
                            {errors.delivery && <p className="text-red-500 text-xs mt-1">{errors.delivery}</p>}
                          </div>

                          {/* Self-pickup address display */}
                          {formData.delivery === 'self-pickup' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">è‡ªå–åœ°å€</label>
                              <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700">
                                {SELF_PICKUP_ADDRESS}
                              </div>
                              <p className="text-gray-500 text-xs mt-1">è‡ªå–åœ°å€ä¸ºåªè¯»ï¼Œæ— éœ€å¡«å†™</p>
                            </div>
                          )}

                          {/* Delivery address input */}
                          {formData.delivery === 'lalamove' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">é…é€åœ°å€ *</label>
                              <textarea 
                                name="deliveryAddress" 
                                value={formData.deliveryAddress} 
                                onChange={handleChange} 
                                rows="3" 
                                className="input-field" 
                                placeholder="è¯·è¾“å…¥è¯¦ç»†çš„é…é€åœ°å€"
                              />
                              {errors.deliveryAddress && <p className="text-red-500 text-xs mt-1">{errors.deliveryAddress}</p>}
                            </div>
                          )}

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ä»˜æ¬¾æ–¹å¼ *</label>
                            <select name="paymentMethod" value={formData.paymentMethod} onChange={handleChange} className="input-field">
                              <option value="">è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼</option>
                              <option value="Maybank QR">Maybank QR</option>
                              <option value="TNG eWallet">TNG eWallet</option>
                            </select>
                            {errors.paymentMethod && <p className="text-red-500 text-xs mt-1">{errors.paymentMethod}</p>}
                          </div>

                          {/* Payment QR codes */}
                          {formData.paymentMethod === 'Maybank QR' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">Maybank äºŒç»´ç </label>
                              <div className="flex justify-center p-4 bg-gray-50 rounded-lg">
                                <img 
                                  src="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/IMG_4042.png" 
                                  alt="Maybank QRç " 
                                  className="max-w-xs max-h-64 object-contain"
                                />
                              </div>
                            </div>
                          )}

                          {formData.paymentMethod === 'TNG eWallet' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">TNG eWallet äºŒç»´ç </label>
                              <div className="flex justify-center p-4 bg-gray-50 rounded-lg">
                                <img 
                                  src="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/IMG_4043.jpeg" 
                                  alt="TNG eWalletäºŒç»´ç " 
                                  className="max-w-xs max-h-64 object-contain"
                                />
                              </div>
                            </div>
                          )}

                          {(formData.paymentMethod === 'Maybank QR' || formData.paymentMethod === 'TNG eWallet') && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">ä¸Šä¼ æ”¯ä»˜å‡­è¯ *</label>
                              <input type="file" onChange={handleFileChange} accept="image/*,.pdf" className="input-field" />
                              {fileName && <p className="text-green-600 text-xs mt-1">å·²é€‰æ‹©: {fileName}</p>}
                              {errors.paymentProof && <p className="text-red-500 text-xs mt-1">{errors.paymentProof}</p>}
                            </div>
                          )}

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨ (å¯é€‰)</label>
                            <textarea 
                              name="remarks" 
                              value={formData.remarks} 
                              onChange={handleChange} 
                              rows="3" 
                              className="input-field" 
                              placeholder="å¦‚æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œè¯·åœ¨æ­¤è¯´æ˜"
                            />
                          </div>
                          
                          <div className="flex items-start gap-2">
                            <input type="checkbox" checked={agree} onChange={(e) => setAgree(e.target.checked)} className="mt-1" />
                            <label className="text-sm text-gray-600">
                              æˆ‘å·²é˜…è¯»å¹¶åŒæ„<a href="#" className="text-red-600 underline">æœåŠ¡æ¡æ¬¾</a>å’Œ<a href="#" className="text-red-600 underline">éšç§æ”¿ç­–</a>
                            </label>
                          </div>
                          {errors.agree && <p className="text-red-500 text-xs">{errors.agree}</p>}
                        </form>
                      </div>
                      <div className="modal-footer">
                        <div className="w-full">
                          <div className="flex justify-between items-center mb-4">
                            <span className="text-lg font-medium">è®¢å•æ€»è®¡:</span>
                            <span className="text-2xl font-bold text-red-600">RM{total.toFixed(2)}</span>
                          </div>
                          <button onClick={handleNextStep} className="btn-primary w-full py-3">
                            ç¡®è®¤è®¢å•
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              };


              // ç”Ÿæˆæ—§ç‰ˆæ ¼å¼çš„è®¢å•å·ï¼šFW+YYYYMMDD+ä¸‰ä½æµæ°´å·
              const generateOrderId = async () => {
                const today = new Date();
                const dateStr = today.getFullYear().toString() + 
                                (today.getMonth() + 1).toString().padStart(2, '0') + 
                                today.getDate().toString().padStart(2, '0');
                
                // è·å–ä»Šå¤©å·²æœ‰çš„è®¢å•æ¥ç¡®å®šæµæ°´å·
                const { data: todayOrders } = await supabaseClient
                  .from('orders')
                  .select('order_id')
                  .ilike('order_id', `FW${dateStr}%`)
                  .order('order_id', { ascending: false })
                  .limit(1);
                
                let sequenceNumber = 1;
                if (todayOrders && todayOrders.length > 0) {
                  const lastOrderId = todayOrders[0].order_id;
                  const lastSequence = parseInt(lastOrderId.substring(10)); // å–æœ€å3ä½æ•°å­—
                  sequenceNumber = lastSequence + 1;
                }
                
                return `FW${dateStr}${sequenceNumber.toString().padStart(3, '0')}`;
              };

              const ConfirmationModal = ({ orderData, onConfirm, onCancel, showToast }) => {
                const [isSubmitting, setIsSubmitting] = useState(false);
                const handleSubmit = async () => {
                  setIsSubmitting(true);
                  try {
                    const { paymentProof, cart, total, pickup_address, ...formData } = orderData;
                    
                    // Validate stock availability before submitting order
                    for (const item of cart) {
                      if (!item.is_unlimited) {
                        const { data: productData, error: productError } = await supabaseClient
                          .from('products')
                          .select('stock_quantity')
                          .eq('id', item.id)
                          .single();
                          
                        if (productError) {
                          throw new Error(`è·å–å•†å“åº“å­˜å¤±è´¥: ${productError.message}`);
                        }
                        
                        const currentStock = productData.stock_quantity ?? 0;
                        if (item.quantity > currentStock) {
                          throw new Error(`å•†å“"${item.name}"åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š${currentStock}ä»¶ï¼Œè®¢å•éœ€è¦ï¼š${item.quantity}ä»¶`);
                        }
                      }
                    }
                    
                    // ç”Ÿæˆæ–°æ ¼å¼çš„è®¢å•å·
                    const orderId = await generateOrderId();
                    
                    const orderInsertData = {
                      order_id: orderId,
                      name: formData.name,
                      phone: formData.phone,
                      delivery_method: formData.delivery,
                      pickup_address: pickup_address || null,
                      delivery_address: formData.deliveryAddress || null,
                      remarks: formData.remarks || '',
                      payment_method: formData.paymentMethod,
                      total_amount: total,
                      status: 'pending',
                      order_items: cart.map(item => ({
                        product: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        emoji: item.emoji,
                        is_unlimited: item.is_unlimited
                      })),
                      created_at: new Date().toISOString()
                    };
                    let paymentProofUrl = null;
                    if (paymentProof) {
                      const fileName = 'payment-proof-' + Date.now() + '.' + paymentProof.name.split('.').pop();
                      const { error: uploadError } = await supabaseClient.storage.from('payment-proofs').upload(fileName, paymentProof);
                      if (uploadError) {
                        throw new Error('ä¸Šä¼ æ”¯ä»˜å‡­è¯å¤±è´¥: ' + uploadError.message);
                      }
                      const { data: { publicUrl } } = supabaseClient.storage.from('payment-proofs').getPublicUrl(fileName);
                      paymentProofUrl = publicUrl;
                    }
                    if (paymentProofUrl) {
                      orderInsertData.payment_proof_url = paymentProofUrl;
                    }
                    const { data: insertedOrder, error: insertError } = await supabaseClient.from('orders').insert([orderInsertData]).select().single();
                    if (insertError) throw insertError;
                    for (const item of cart) {
                      if (!item.is_unlimited && item.stock_quantity !== undefined) {
                        const newStock = Math.max(0, item.stock_quantity - item.quantity);
                        await supabaseClient.from('products').update({ stock_quantity: newStock }).eq('id', item.id);
                      }
                    }
                    showToast('è®¢å•æäº¤æˆåŠŸï¼', 'success');
                    onConfirm(insertedOrder);
                  } catch (error) {
                    console.error('è®¢å•æäº¤å¤±è´¥:', error);
                    showToast('è®¢å•æäº¤å¤±è´¥: ' + error.message, 'danger');
                  } finally {
                    setIsSubmitting(false);
                  }
                };
                return (
                  <div className="modal-overlay">
                    <div className="modal-content max-w-2xl">
                      <div className="modal-header">
                        <h2 className="text-xl font-bold">ç¡®è®¤è®¢å•</h2>
                        <button onClick={onCancel} disabled={isSubmitting} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                      </div>
                      <div className="modal-body">
                        <div className="space-y-4">
                          <div>
                            <h3 className="font-medium text-gray-800 mb-2">å®¢æˆ·ä¿¡æ¯</h3>
                            <p>å§“å: {orderData.name}</p>
                            <p>ç”µè¯: {orderData.phone}</p>
                            <p>å–è´§æ–¹å¼: {orderData.delivery === 'self-pickup' ? 'è‡ªå–' : 'Lalamoveé€è´§'}</p>
                            {orderData.delivery === 'self-pickup' && (
                              <p>å–è´§åœ°å€: {SELF_PICKUP_ADDRESS}</p>
                            )}
                            {orderData.delivery === 'lalamove' && orderData.deliveryAddress && (
                              <p>é…é€åœ°å€: {orderData.deliveryAddress}</p>
                            )}
                            <p>ä»˜æ¬¾æ–¹å¼: {orderData.paymentMethod}</p>
                            {orderData.remarks && <p>å¤‡æ³¨: {orderData.remarks}</p>}
                          </div>
                          <div>
                            <h3 className="font-medium text-gray-800 mb-2">è®¢å•æ˜ç»†</h3>
                            {orderData.cart.map(item => (
                              <div key={item.id} className="flex justify-between items-center py-2 border-b">
                                <span>{item.emoji} {item.name} Ã— {item.quantity}</span>
                                <span>RM{(item.price * item.quantity).toFixed(2)}</span>
                              </div>
                            ))}
                            <div className="flex justify-between items-center py-2 font-bold text-lg">
                              <span>æ€»è®¡:</span>
                              <span className="text-red-600">RM{orderData.total.toFixed(2)}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div className="modal-footer">
                        <button onClick={onCancel} disabled={isSubmitting} className="btn-secondary">
                          è¿”å›ä¿®æ”¹
                        </button>
                        <button onClick={handleSubmit} disabled={isSubmitting} className="btn-primary">
                          {isSubmitting ? 'æäº¤ä¸­...' : 'ç¡®è®¤å¹¶æäº¤'}
                        </button>
                      </div>
                    </div>
                  </div>
                );
              };

              const OrderSuccessModal = ({ order, onNewOrder }) => {
                const [showDialog, setShowDialog] = useState(true);
                const [showSuccess, setShowSuccess] = useState(false);
                const [hasRedirected, setHasRedirected] = useState(false);
                const buildWhatsAppMessage = useCallback(() => {
                  try {
                    let msg = 'ğŸ›ï¸ *é”‹å‘³æ´¾æ–°è®¢å• #' + order.order_id + '*\n\n';
                    msg += 'ğŸ‘¤ *å®¢æˆ·ä¿¡æ¯*\n';
                    msg += 'ğŸ“› å§“å: ' + order.name + '\n';
                    msg += 'ğŸ“± ç”µè¯: ' + order.phone + '\n';
                    msg += 'ğŸšš å–è´§æ–¹å¼: ' + (order.delivery_method === 'self-pickup' ? 'è‡ªå–' : 'Lalamoveé€è´§') + '\n';
                    if (order.delivery_method === 'self-pickup') {
                      msg += 'ğŸ“ è‡ªå–åœ°å€: ' + SELF_PICKUP_ADDRESS + '\n';
                      msg += 'â° å–è´§æ—¶é—´: å¦è¡Œé€šçŸ¥\n';
                      msg += 'ğŸ“ è”ç»œå·ç : 0162327792\n';
                    } else if (order.delivery_address) {
                      msg += 'ğŸ“ é…é€åœ°å€: ' + order.delivery_address + '\n';
                    }
                    msg += '\nğŸ›’ *è®¢å•æ˜ç»†*\n';
                    if (Array.isArray(order.order_items)) {
                      order.order_items.forEach(item => {
                        let emoji = item.emoji;
                        if (!emoji) {
                          const n = item.product || '';
                          if (n.includes('çƒ¤è‚ ')) emoji = 'ğŸŒ­';
                          else if (n.includes('è™¾')) emoji = 'ğŸ¦';
                          else if (n.includes('æŠ«è¨')) emoji = 'ğŸ•';
                          else if (n.includes('æ±¤åŒ…')) emoji = 'ğŸ¥Ÿ';
                          else if (n.includes('é…¥é¥¼')) emoji = 'ğŸ¥®';
                          else if (n.includes('é¸¡æ’') || n.includes('é¸¡ç¿…')) emoji = 'ğŸ—';
                          else emoji = 'â–«ï¸';
                        }
                        const typeLabel = item.is_unlimited ? ' (é¢„è´­)' : ' (ç°è´§)';
                        msg += emoji + ' ' + item.product + typeLabel + ' Ã— ' + item.quantity + ' = RM' + (item.quantity * item.price).toFixed(2) + '\n';
                      });
                    }
                    msg += '\nğŸ’° *æ€»é‡‘é¢: RM' + Number(order.total_amount).toFixed(2) + '*\n';
                    msg += 'ğŸ“ *å¤‡æ³¨*: ' + (order.remarks || 'æ— ') + '\n';
                    const createdAt = order.created_at ? new Date(order.created_at) : new Date();
                    msg += 'ğŸ“… *ä¸‹å•æ—¶é—´*: ' + createdAt.toLocaleString('zh-CN');
                    return msg;
                  } catch (e) {
                    console.error('[buildWhatsAppMessage] error:', e, order);
                    return 'è®¢å•ä¿¡æ¯ç”Ÿæˆå¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚';
                  }
                }, [order]);
                const whatsappMsg = buildWhatsAppMessage();
                const whatsappUrl = 'https://wa.me/60162327792?text=' + encodeURIComponent(whatsappMsg);
                const handleCopy = useCallback(async () => {
                  try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                      await navigator.clipboard.writeText(whatsappMsg);
                      alert('è®¢å•ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } else {
                      const ta = document.createElement('textarea');
                      ta.value = whatsappMsg;
                      ta.style.position = 'fixed';
                      ta.style.top = '-2000px';
                      document.body.appendChild(ta);
                      ta.select();
                      document.execCommand('copy');
                      document.body.removeChild(ta);
                      alert('è®¢å•ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }
                  } catch (err) {
                    window.alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰é€‰æ‹©æ‰‹åŠ¨å¤åˆ¶ã€‚');
                    console.error('[OrderSuccessModal] Clipboard copy error:', err);
                  }
                }, [whatsappMsg]);
                const handleSend = useCallback(() => {
                  setShowDialog(false);
                  setShowSuccess(true);
                }, []);
                const handleSuccessConfirm = useCallback(() => {
                  try {
                    if (!hasRedirected) {
                      setHasRedirected(true);
                      window.location.href = whatsappUrl;
                    }
                  } catch (err) {
                    window.alert('è·³è½¬WhatsAppå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å‘é€è®¢å•ä¿¡æ¯ã€‚');
                    console.error('[OrderSuccessModal] WhatsApp redirect error:', err);
                  }
                  setShowSuccess(false);
                  onNewOrder();
                }, [hasRedirected, whatsappUrl, onNewOrder]);
                if (showDialog) {
                  return (
                    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                      <div className="bg-white rounded-lg shadow-xl w-full max-w-md text-center animate-fade-in">
                        <div className="p-6">
                          <i className="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                          <h2 className="text-2xl font-bold mb-4">è®¢å•æäº¤æˆåŠŸ!</h2>
                          <div className="bg-gray-100 p-4 rounded-lg mb-4 text-left text-sm max-h-40 overflow-y-auto">
                            <pre className="whitespace-pre-wrap font-mono text-xs">{whatsappMsg}</pre>
                          </div>
                          <p className="text-gray-600 mb-4">è¯·ç‚¹å‡»"å‘é€åˆ°WhatsApp"å°†è®¢å•ä¿¡æ¯å‘é€ç»™æˆ‘ä»¬ï¼Œæˆ–å…ˆ"å¤åˆ¶è®¢å•"æ‰‹åŠ¨å‘é€ã€‚</p>
                          <div className="space-y-2">
                            <button onClick={handleSend} className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                              <i className="fab fa-whatsapp"></i> å‘é€åˆ°WhatsApp
                            </button>
                            <button onClick={handleCopy} className="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                              å¤åˆ¶è®¢å•ä¿¡æ¯
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                }
                if (showSuccess) {
                  return (
                    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                      <div className="bg-white rounded-lg shadow-xl w-full max-w-md text-center animate-fade-in">
                        <div className="p-6">
                          <i className="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                          <h2 className="text-2xl font-bold mb-2">è®¢å•æäº¤æˆåŠŸ!</h2>
                          <p className="text-gray-600 mb-4">è®¢å•å·²æˆåŠŸä¿å­˜ï¼Œè¯·ç‚¹å‡»"å¥½çš„"è·³è½¬åˆ°WhatsAppå‘é€è®¢å•ä¿¡æ¯ã€‚</p>
                          <button onClick={handleSuccessConfirm} className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors mb-3">å¥½çš„ (OK)</button>
                        </div>
                      </div>
                    </div>
                  );
                }
                return null;
              };

              const LoadingOverlay = ({ text }) => (
                <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50">
                  <div className="bg-white p-8 rounded-lg shadow-xl text-center">
                    <LoadingSpinner text={text} />
                  </div>
                </div>
              );


              function Dashboard({ setView }) {
                const [stats, setStats] = useState({
                  todaySales: 0,
                  monthSales: 0,
                  todayOrders: 0,
                  pendingOrders: 0,
                  availableProducts: 0,
                  lowStock: 0,
                  totalStock: 0,
                  stockValue: 0
                });

                const [presaleStats, setPresaleStats] = useState({
                  totalBoxes: 0,
                  completedGroups: 0,
                  remainingBoxes: 0
                });

                useEffect(() => {
                  const fetchStats = async () => {
                    try {
                      // è·å–ä»Šæ—¥è®¢å•
                      const today = new Date().toISOString().slice(0, 10);
                      const { data: todayOrders } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .gte('created_at', today + 'T00:00:00');

                      // è·å–æœ¬æœˆè®¢å•
                      const monthStart = new Date();
                      monthStart.setDate(1);
                      const { data: monthOrders } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .gte('created_at', monthStart.toISOString());

                      // è·å–å¾…å¤„ç†è®¢å•
                      const { data: pendingOrders } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .eq('status', 'pending');

                      // è·å–å•†å“åº“å­˜ä¿¡æ¯
                      const { data: products } = await supabaseClient
                        .from('products')
                        .select('*');

                      // è·å–æ‰€æœ‰è®¢å•ç”¨äºé¢„å”®ç»Ÿè®¡
                      const { data: allOrders } = await supabaseClient
                        .from('orders')
                        .select('*, order_items(*)');

                      // è®¡ç®—é¢„å”®æˆå›¢ç»Ÿè®¡
                      let totalPresaleBoxes = 0;
                      if (allOrders) {
                        allOrders.forEach(order => {
                          if (order.order_items) {
                            order.order_items.forEach(item => {
                              // æ’é™¤ç°è´§å’Œè¿è´¹ä¸“ç”¨å•†å“
                              if (item.product && 
                                  !item.product.includes('è¿è´¹') && 
                                  item.product !== 'è¿è´¹ä¸“ç”¨') {
                                // æŸ¥æ‰¾å¯¹åº”çš„äº§å“ä¿¡æ¯
                                const product = products?.find(p => p.name === item.product);
                                // åªç»Ÿè®¡é¢„å”®å•†å“ï¼ˆis_unlimitedä¸ºtrueçš„å•†å“ï¼‰
                                if (product && product.is_unlimited) {
                                  totalPresaleBoxes += item.quantity || 0;
                                }
                              }
                            });
                          }
                        });
                      }

                      const completedGroups = Math.floor(totalPresaleBoxes / 200);
                      const remainingBoxes = 200 - (totalPresaleBoxes % 200);

                      setPresaleStats({
                        totalBoxes: totalPresaleBoxes,
                        completedGroups,
                        remainingBoxes: remainingBoxes === 200 ? 0 : remainingBoxes
                      });

                      const todaySales = (todayOrders || []).reduce((sum, order) => sum + Number(order.total_amount), 0);
                      const monthSales = (monthOrders || []).reduce((sum, order) => sum + Number(order.total_amount), 0);
                      // æ€»åº“å­˜åªè®¡ç®—ç°è´§å•†å“ï¼ˆéé¢„è´­å•†å“ï¼‰çš„åº“å­˜æ•°é‡
                      const totalStock = (products || [])
                        .filter(p => !p.is_unlimited) // åªè®¡ç®—éé¢„è´­å•†å“
                        .reduce((sum, p) => sum + (p.stock_quantity || 0), 0);
                      // åº“å­˜ä»·å€¼ä¹Ÿåªè®¡ç®—ç°è´§å•†å“
                      const stockValue = (products || [])
                        .filter(p => !p.is_unlimited)
                        .reduce((sum, p) => sum + ((p.stock_quantity || 0) * (p.price || 0)), 0);
                      const lowStockCount = (products || []).filter(p => (p.stock_quantity || 0) <= (p.min_stock_threshold || 5)).length;

                      setStats({
                        todaySales,
                        monthSales,
                        todayOrders: (todayOrders || []).length,
                        pendingOrders: (pendingOrders || []).length,
                        availableProducts: (products || []).filter(p => p.is_published).length,
                        lowStock: lowStockCount,
                        totalStock,
                        stockValue
                      });
                    } catch (error) {
                      console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                    }
                  };

                  fetchStats();
                }, []);

                return (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800">ä»ªè¡¨æ¿</h2>
                    
                    {/* é¢„å”®æˆå›¢ç»Ÿè®¡ */}
                    <div className="bg-gradient-to-r from-pink-500 to-rose-500 rounded-lg shadow-lg text-white p-6">
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                          <i className="fas fa-users text-2xl"></i>
                          <h3 className="text-xl font-bold">é¢„å”®æˆå›¢ç»Ÿè®¡</h3>
                        </div>
                        <div className="text-sm bg-white/20 px-3 py-1 rounded-full">
                          æ¯200ç›’æˆå›¢
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white/10 rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium opacity-90">å·²æˆå›¢æ•°</p>
                              <p className="text-2xl font-bold">{presaleStats.completedGroups}å›¢</p>
                            </div>
                            <i className="fas fa-check-circle text-2xl opacity-80"></i>
                          </div>
                        </div>
                        <div className="bg-white/10 rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium opacity-90">æ€»å”®å‡ºæ•°é‡</p>
                              <p className="text-2xl font-bold">{presaleStats.totalBoxes}ç›’</p>
                            </div>
                            <i className="fas fa-box text-2xl opacity-80"></i>
                          </div>
                        </div>
                        <div className="bg-white/10 rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium opacity-90">ä¸‹ä¸€å›¢è¿˜éœ€</p>
                              <p className="text-2xl font-bold">{presaleStats.remainingBoxes}ç›’</p>
                            </div>
                            <i className="fas fa-hourglass-half text-2xl opacity-80"></i>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* ç»Ÿè®¡å¡ç‰‡ */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">ä»Šæ—¥é”€å”®é¢</h3>
                            <p className="text-2xl font-bold text-green-600">RM{stats.todaySales.toFixed(2)}</p>
                          </div>
                          <i className="fas fa-chart-line text-3xl text-green-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">æœ¬æœˆé”€å”®é¢</h3>
                            <p className="text-2xl font-bold text-blue-600">RM{stats.monthSales.toFixed(2)}</p>
                          </div>
                          <i className="fas fa-calendar-alt text-3xl text-blue-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">ä»Šæ—¥è®¢å•</h3>
                            <p className="text-2xl font-bold text-purple-600">{stats.todayOrders}</p>
                          </div>
                          <i className="fas fa-shopping-cart text-3xl text-purple-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">å¾…å¤„ç†è®¢å•</h3>
                            <p className="text-2xl font-bold text-orange-600">{stats.pendingOrders}</p>
                          </div>
                          <i className="fas fa-clock text-3xl text-orange-500"></i>
                        </div>
                      </div>
                    </div>

                    {/* åº“å­˜æ¦‚è§ˆ */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">ä¸Šæ¶å•†å“</h3>
                            <p className="text-2xl font-bold text-indigo-600">{stats.availableProducts}</p>
                          </div>
                          <i className="fas fa-store text-3xl text-indigo-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow cursor-pointer hover:bg-gray-50" onClick={() => setView('inventory')}>
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">æ€»åº“å­˜</h3>
                            <p className="text-2xl font-bold text-teal-600">{stats.totalStock}</p>
                          </div>
                          <i className="fas fa-boxes text-3xl text-teal-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow cursor-pointer hover:bg-gray-50" onClick={() => setView('inventory')}>
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">åº“å­˜ä»·å€¼</h3>
                            <p className="text-2xl font-bold text-emerald-600">RM{stats.stockValue.toFixed(2)}</p>
                          </div>
                          <i className="fas fa-dollar-sign text-3xl text-emerald-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow cursor-pointer hover:bg-gray-50" onClick={() => setView('inventory')}>
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">ä½åº“å­˜å•†å“</h3>
                            <p className="text-2xl font-bold text-red-600">{stats.lowStock}</p>
                          </div>
                          <i className="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                        </div>
                      </div>
                    </div>

                    {/* å¿«æ·æ“ä½œ */}
                    <div className="bg-white p-6 rounded-lg shadow">
                      <h3 className="text-lg font-semibold mb-4">å¿«æ·æ“ä½œ</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onClick={() => setView('orders')} className="flex flex-col items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                          <i className="fas fa-list text-2xl text-blue-600 mb-2"></i>
                          <span className="text-sm font-medium text-blue-700">æŸ¥çœ‹è®¢å•</span>
                        </button>
                        
                        <button onClick={() => setView('products')} className="flex flex-col items-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                          <i className="fas fa-pizza-slice text-2xl text-green-600 mb-2"></i>
                          <span className="text-sm font-medium text-green-700">ç®¡ç†å•†å“</span>
                        </button>
                        
                        <button onClick={() => setView('inventory')} className="flex flex-col items-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                          <i className="fas fa-boxes text-2xl text-purple-600 mb-2"></i>
                          <span className="text-sm font-medium text-purple-700">åº“å­˜ç®¡ç†</span>
                        </button>
                        
                        <button onClick={() => setView('analytics')} className="flex flex-col items-center p-4 bg-orange-50 hover:bg-orange-100 rounded-lg transition-colors">
                          <i className="fas fa-chart-pie text-2xl text-orange-600 mb-2"></i>
                          <span className="text-sm font-medium text-orange-700">æ•°æ®åˆ†æ</span>
                        </button>
                      </div>
                    </div>
                  </div>
                );
              }


              // Simple admin components - focusing on functionality over complex features
              function Products() {
                const [products, setProducts] = useState([]);
                const [loading, setLoading] = useState(true);

                const fetchProducts = async () => {
                  setLoading(true);
                  const { data, error } = await supabaseClient.from('products').select('*').order('id');
                  if (!error) setProducts(data || []);
                  setLoading(false);
                };

                useEffect(() => { fetchProducts(); }, []);

                if (loading) return <LoadingSpinner text="åŠ è½½äº§å“æ•°æ®..." />;

                return (
                  <div className="bg-white p-6 rounded-lg shadow">
                    <h2 className="text-lg font-bold mb-4">äº§å“ç®¡ç† ({products.length})</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-gray-50">
                            <th className="p-3 text-left">å•†å“</th>
                            <th className="p-3 text-left">ä»·æ ¼</th>
                            <th className="p-3 text-left">åº“å­˜</th>
                            <th className="p-3 text-left">åˆ†ç±»</th>
                            <th className="p-3 text-left">çŠ¶æ€</th>
                          </tr>
                        </thead>
                        <tbody>
                          {products.map(p => (
                            <tr key={p.id} className="border-b hover:bg-gray-50">
                              <td className="p-3">
                                <div className="flex items-center gap-2">
                                  <span className="text-lg">{p.emoji || 'ğŸ½ï¸'}</span>
                                  <span className="font-medium">{p.name}</span>
                                </div>
                              </td>
                              <td className="p-3">RM{Number(p.price || 0).toFixed(2)}</td>
                              <td className="p-3">
                                {p.is_unlimited ? (
                                  <span className="text-blue-600 font-medium">æ— é™åˆ¶</span>
                                ) : (
                                  <span className="font-medium">{p.stock_quantity ?? 0}</span>
                                )}
                              </td>
                              <td className="p-3">{p.category || '-'}</td>
                              <td className="p-3">
                                <span className={`px-2 py-1 rounded-full text-xs ${
                                  p.is_published ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                }`}>
                                  {p.is_published ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶'}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                );
              }

              function Inventory() {
                const [products, setProducts] = useState([]);
                const [loading, setLoading] = useState(true);

                useEffect(() => {
                  const fetchData = async () => {
                    setLoading(true);
                    const { data: ps } = await supabaseClient.from('products').select('*');
                    setProducts(ps || []);
                    setLoading(false);
                  };
                  fetchData();
                }, []);

                const total = products.filter(p => !p.is_unlimited).reduce((s, p) => s + ((p.stock_quantity ?? 0)), 0);
                const value = products.filter(p => !p.is_unlimited).reduce((s, p) => s + (((p.stock_quantity ?? 0) * (p.price || 0))), 0);

                if (loading) return <LoadingSpinner text="åŠ è½½åº“å­˜æ•°æ®..." />;

                return (
                  <div className="space-y-6">
                    <div className="grid md:grid-cols-2 gap-4">
                      <div className="bg-white p-5 rounded shadow">
                        <h3 className="text-sm text-gray-500">æ€»åº“å­˜</h3>
                        <p className="text-xl font-semibold mt-1">{total}</p>
                      </div>
                      <div className="bg-white p-5 rounded shadow">
                        <h3 className="text-sm text-gray-500">åº“å­˜ä»·å€¼</h3>
                        <p className="text-xl font-semibold mt-1">RM{value.toFixed(2)}</p>
                      </div>
                    </div>

                    <div className="bg-white p-5 rounded shadow">
                      <h3 className="font-semibold mb-4">äº§å“åº“å­˜è¯¦æƒ…</h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="bg-gray-50">
                              <th className="p-3 text-left">å•†å“</th>
                              <th className="p-3 text-left">ç±»åˆ«</th>
                              <th className="p-3 text-left">å½“å‰åº“å­˜</th>
                              <th className="p-3 text-left">çŠ¶æ€</th>
                            </tr>
                          </thead>
                          <tbody>
                            {products.map(p => (
                              <tr key={p.id} className="border-b hover:bg-gray-50">
                                <td className="p-3">
                                  <div className="flex items-center gap-2">
                                    <span className="text-lg">{p.emoji || 'ğŸ½ï¸'}</span>
                                    <span className="font-medium">{p.name}</span>
                                  </div>
                                </td>
                                <td className="p-3">{p.category || '-'}</td>
                                <td className="p-3">
                                  {p.is_unlimited ? 'æ— é™åˆ¶' : (p.stock_quantity ?? 0)}
                                </td>
                                <td className="p-3">
                                  <span className={`px-2 py-1 rounded-full text-xs ${
                                    p.is_published ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                  }`}>
                                    {p.is_published ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶'}
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                );
              }

              function Orders() {
                const [orders, setOrders] = useState([]);
                const [loading, setLoading] = useState(true);

                const fetchOrders = useCallback(async () => {
                  setLoading(true);
                  const { data } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                  setOrders(data || []);
                  setLoading(false);
                }, []);

                useEffect(() => { fetchOrders(); }, [fetchOrders]);

                const updateStatus = async (id, status) => {
                  await supabaseClient.from('orders').update({ status }).eq('id', id);
                  fetchOrders();
                };

                const copyDetails = async (o) => {
                  await copyTextUniversal(buildOrderMessage(o).replace(/\*/g, ''));
                };

                if (loading) return <LoadingSpinner text="åŠ è½½è®¢å•..." />;

                return (
                  <div className="bg-white p-6 rounded-lg shadow">
                    <h2 className="text-lg font-bold mb-4">è®¢å•ç®¡ç† ({orders.length})</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="p-3 text-left">è®¢å•å·</th>
                            <th className="p-3 text-left">å®¢æˆ·</th>
                            <th className="p-3 text-left">é‡‘é¢</th>
                            <th className="p-3 text-left">çŠ¶æ€</th>
                            <th className="p-3 text-left">æ—¶é—´</th>
                            <th className="p-3 text-left">æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody>
                          {orders.map(order => (
                            <tr key={order.id} className="border-b hover:bg-gray-50">
                              <td className="p-3">
                                <span className="font-medium text-blue-600">{order.order_id}</span>
                                <div className="text-xs text-gray-500">{order.delivery_method === 'self-pickup' ? 'è‡ªå–' : 'é…é€'}</div>
                              </td>
                              <td className="p-3">
                                <div className="font-medium">{order.name}</div>
                                <div className="text-xs text-gray-500">{order.phone}</div>
                              </td>
                              <td className="p-3">
                                <span className="text-red-600 font-semibold">RM{Number(order.total_amount || 0).toFixed(2)}</span>
                              </td>
                              <td className="p-3">
                                <select
                                  className="text-xs border rounded px-2 py-1"
                                  value={order.status}
                                  onChange={(e) => updateStatus(order.id, e.target.value)}
                                >
                                  <option value="pending">å¾…å¤„ç†</option>
                                  <option value="ready for pick up">å¾…å–è´§</option>
                                  <option value="delivered">å·²å‘è´§</option>
                                  <option value="completed">å·²å®Œæˆ</option>
                                  <option value="cancelled">å·²å–æ¶ˆ</option>
                                </select>
                              </td>
                              <td className="p-3 text-xs">{new Date(order.created_at).toLocaleString('zh-CN')}</td>
                              <td className="p-3">
                                <button
                                  onClick={() => copyDetails(order)}
                                  className="bg-blue-500 hover:bg-blue-600 text-white text-xs rounded px-2 py-1"
                                >
                                  å¤åˆ¶è¯¦æƒ…
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                );
              }

              // Simple Scanner component
              function Scanner() {
                const [results, setResults] = useState([]);
                const [active, setActive] = useState(false);

                return (
                  <div className="bg-white p-6 rounded-lg shadow">
                    <h2 className="text-lg font-bold mb-4">æ‰«ç åŠŸèƒ½</h2>
                    <div className="space-y-4">
                      <button 
                        onClick={() => setActive(!active)} 
                        className={`px-4 py-2 rounded ${active ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`}
                      >
                        {active ? 'åœæ­¢æ‰«ç ' : 'å¯åŠ¨æ‰«ç '}
                      </button>
                      <div className="border p-4 rounded bg-gray-50">
                        <h3 className="font-medium mb-2">æ‰«ç ç»“æœ</h3>
                        <div className="text-sm text-gray-600">
                          {results.length === 0 ? 'æš‚æ— æ‰«ç è®°å½•' : results.slice(0, 5).map((result, index) => (
                            <div key={index} className="py-1">{result}</div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              }

              // Simple Camera component  
              function Camera() {
                const [photo, setPhoto] = useState(null);
                const [streaming, setStreaming] = useState(false);

                const takePhoto = () => {
                  // Simulate taking a photo
                  setPhoto('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==');
                };

                return (
                  <div className="bg-white p-6 rounded-lg shadow">
                    <h2 className="text-lg font-bold mb-4">æ‹ç…§åŠŸèƒ½</h2>
                    <div className="space-y-4">
                      <div className="flex gap-2">
                        <button 
                          onClick={() => setStreaming(!streaming)} 
                          className={`px-4 py-2 rounded ${streaming ? 'bg-red-600 text-white' : 'bg-blue-600 text-white'}`}
                        >
                          {streaming ? 'å…³é—­ç›¸æœº' : 'æ‰“å¼€ç›¸æœº'}
                        </button>
                        <button 
                          onClick={takePhoto} 
                          disabled={!streaming}
                          className="px-4 py-2 rounded bg-green-600 text-white disabled:bg-gray-400"
                        >
                          æ‹ç…§
                        </button>
                      </div>
                      <div className="border p-4 rounded bg-gray-50">
                        <h3 className="font-medium mb-2">ç›¸æœºé¢„è§ˆ</h3>
                        <div className="w-64 h-48 bg-gray-200 rounded flex items-center justify-center">
                          {streaming ? (
                            <span className="text-gray-600">ç›¸æœºè¿è¡Œä¸­...</span>
                          ) : (
                            <span className="text-gray-400">ç›¸æœºæœªå¯åŠ¨</span>
                          )}
                        </div>
                      </div>
                      {photo && (
                        <div className="border p-4 rounded">
                          <h3 className="font-medium mb-2">æ‹æ‘„ç…§ç‰‡</h3>
                          <img src={photo} alt="æ‹æ‘„çš„ç…§ç‰‡" className="w-32 h-24 object-cover rounded" />
                        </div>
                      )}
                    </div>
                  </div>
                );
              }

              // Simple Analytics component
              function Analytics() {
                const [orders, setOrders] = useState([]);
                const [loading, setLoading] = useState(true);

                useEffect(() => {
                  const fetchData = async () => {
                    setLoading(true);
                    const { data } = await supabaseClient.from('orders').select('*');
                    setOrders(data || []);
                    setLoading(false);
                  };
                  fetchData();
                }, []);

                if (loading) return <LoadingSpinner text="åŠ è½½æ•°æ®åˆ†æ..." />;

                const totalSales = orders.reduce((sum, order) => sum + Number(order.total_amount), 0);
                const totalOrders = orders.length;

                return (
                  <div className="bg-white p-6 rounded-lg shadow space-y-6">
                    <h2 className="text-lg font-bold">æ•°æ®åˆ†æ</h2>
                    
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="bg-gray-50 p-4 rounded-lg">
                        <h3 className="font-medium mb-2">æ€»é”€å”®é¢</h3>
                        <p className="text-2xl font-bold text-green-600">RM{totalSales.toFixed(2)}</p>
                      </div>
                      
                      <div className="bg-gray-50 p-4 rounded-lg">
                        <h3 className="font-medium mb-2">æ€»è®¢å•æ•°</h3>
                        <p className="text-2xl font-bold text-blue-600">{totalOrders}</p>
                      </div>
                    </div>

                    <div>
                      <h3 className="font-medium mb-4">æœ€è¿‘è®¢å•</h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="bg-gray-50">
                              <th className="p-2 text-left">è®¢å•å·</th>
                              <th className="p-2 text-left">å®¢æˆ·</th>
                              <th className="p-2 text-left">é‡‘é¢</th>
                              <th className="p-2 text-left">æ—¶é—´</th>
                            </tr>
                          </thead>
                          <tbody>
                            {orders.slice(0, 10).map(order => (
                              <tr key={order.id} className="border-b">
                                <td className="p-2">{order.order_id}</td>
                                <td className="p-2">{order.name}</td>
                                <td className="p-2">RM{Number(order.total_amount).toFixed(2)}</td>
                                <td className="p-2">{new Date(order.created_at).toLocaleDateString()}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                );
              }


              // ========= ä¸»åº”ç”¨ç»„ä»¶ =========
              function App() {
                const [currentView, setCurrentView] = useState('customer');
                const [user, setUser] = useState(null);
                const [toast, setToast] = useState(null);
                const [products, setProducts] = useState([]);
                const [cart, setCart] = useState([]);
                const [isLoading, setIsLoading] = useState(true);
                const [lastOrder, setLastOrder] = useState(null);
                
                const showToast = (message, type = 'success') => {
                  setToast({ message, type });
                  setTimeout(() => setToast(null), 3000);
                };
                
                const fetchProducts = useCallback(async () => {
                  setIsLoading(true);
                  const { data, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('is_published', true)
                    .order('id');
                    
                  if (error) {
                    showToast('åŠ è½½å•†å“å¤±è´¥: ' + error.message, 'danger');
                    setProducts([]);
                  } else {
                    const formattedProducts = data.map(p => {
                      let imgUrl = '';
                      if (p.image_url) {
                        imgUrl = p.image_url;
                      } else if (p.image) {
                        const rawName = String(p.image).trim();
                        imgUrl = rawName.startsWith('http') ? rawName : 
                          ('https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/' + encodeURIComponent(rawName));
                      }
                      return {
                        ...p,
                        image: imgUrl,
                        stock: p.stock_quantity ?? 0,
                        minStock: p.min_stock_threshold ?? 5
                      };
                    });
                    setProducts(formattedProducts);
                  }
                  setIsLoading(false);
                }, []);
                
                useEffect(() => {
                  fetchProducts();
                }, [fetchProducts]);
                
                const addToCart = (product) => {
                  // Check stock availability for non-preorder items (ç°è´§å•†å“)
                  if (!product.is_unlimited) {
                    const availableStock = product.stock_quantity ?? 0;
                    const currentInCart = cart.find(item => item.id === product.id)?.quantity ?? 0;
                    
                    if (availableStock <= 0) {
                      showToast('å•†å“å·²å”®ç½„', 'danger');
                      return;
                    }
                    
                    if (currentInCart >= availableStock) {
                      showToast(`åº“å­˜ä¸è¶³ï¼Œä»…å‰©${availableStock}ä»¶`, 'danger');
                      return;
                    }
                  }
                  
                  setCart(prevCart => {
                    const existingItem = prevCart.find(item => item.id === product.id);
                    if (existingItem) {
                      // Double-check stock limit before updating
                      if (!product.is_unlimited && existingItem.quantity >= (product.stock_quantity ?? 0)) {
                        return prevCart; // Don't update if would exceed stock
                      }
                      return prevCart.map(item =>
                        item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
                      );
                    } else {
                      return [...prevCart, { ...product, quantity: 1 }];
                    }
                  });
                  showToast('å•†å“å·²æ·»åŠ åˆ°è´­ç‰©è½¦', 'success');
                };
                
                const updateCartQuantity = (productId, newQuantity) => {
                  if (newQuantity <= 0) {
                    setCart(prevCart => prevCart.filter(item => item.id !== productId));
                    return;
                  }
                  
                  setCart(prevCart =>
                    prevCart.map(item => {
                      if (item.id === productId) {
                        // Validate stock for non-preorder items (ç°è´§å•†å“)
                        if (!item.is_unlimited) {
                          const availableStock = item.stock_quantity ?? 0;
                          if (newQuantity > availableStock) {
                            // Auto-adjust to maximum available stock
                            showToast(`æ•°é‡å·²è°ƒæ•´ä¸ºåº“å­˜ä¸Šé™ï¼š${availableStock}ä»¶`, 'warning');
                            return { ...item, quantity: availableStock };
                          }
                        }
                        return { ...item, quantity: newQuantity };
                      }
                      return item;
                    })
                  );
                };
                
                const removeFromCart = (productId) => {
                  setCart(prevCart => prevCart.filter(item => item.id !== productId));
                };
                
                const cartTotal = useMemo(() => {
                  return cart.reduce((total, item) => total + Number(item.price) * item.quantity, 0);
                }, [cart]);
                
                const totalItems = useMemo(() => {
                  return cart.reduce((sum, item) => sum + item.quantity, 0);
                }, [cart]);
                
                const renderView = () => {
                  switch(currentView) {
                    case 'customer':
                      return (
                        <CustomerView
                          products={products}
                          cart={cart}
                          addToCart={addToCart}
                          updateCartQuantity={updateCartQuantity}
                          removeFromCart={removeFromCart}
                          cartTotal={cartTotal}
                          totalItems={totalItems}
                          showToast={showToast}
                          refreshProducts={fetchProducts}
                          isLoading={isLoading}
                          setLastOrder={setLastOrder}
                          setCart={setCart}
                          onAdminClick={() => setCurrentView('login')}
                        />
                      );
                    case 'login':
                      return (
                        <LoginScreen
                          onLogin={(u) => { setUser(u); setCurrentView('admin'); }}
                          showToast={showToast}
                        />
                      );
                    case 'admin':
                      return (
                        <Layout
                          onLogout={() => setCurrentView('customer')}
                          currentView={currentView}
                          setCurrentView={setCurrentView}
                        />
                      );
                    default:
                      return (
                        <CustomerView
                          products={products}
                          cart={cart}
                          addToCart={addToCart}
                          updateCartQuantity={updateCartQuantity}
                          removeFromCart={removeFromCart}
                          cartTotal={cartTotal}
                          totalItems={totalItems}
                          showToast={showToast}
                          refreshProducts={fetchProducts}
                          isLoading={isLoading}
                          setLastOrder={setLastOrder}
                          setCart={setCart}
                          onAdminClick={() => setCurrentView('login')}
                        />
                      );
                  }
                };
                
                return (
                  <div className="min-h-screen bg-gray-50">
                    {isLoading && currentView === 'customer' && (
                      <LoadingOverlay text="åŠ è½½ä¸­..." />
                    )}
                    {toast && (
                      <div className="fixed top-4 right-4 z-50">
                        <Toast {...toast} onDismiss={() => setToast(null)} />
                      </div>
                    )}
                    <main>
                      {lastOrder ? (
                        <OrderSuccessModal
                          order={lastOrder}
                          onNewOrder={() => {
                            setLastOrder(null);
                            fetchProducts();
                          }}
                        />
                      ) : (
                        renderView()
                      )}
                    </main>
                  </div>
                );
              }

              function Layout({ onLogout, currentView, setCurrentView }) {
                const [view, setView] = useState('dashboard');
                const [sidebarOpen, setSidebarOpen] = useState(false);
                
                return (
                  <div className="flex flex-col h-screen">
                    <header className="bg-white shadow-sm border-b px-6 py-4">
                      <div className="flex justify-between items-center">
                        <div className="flex items-center gap-3">
                          {/* Mobile menu button */}
                          <button 
                            onClick={() => setSidebarOpen(true)} 
                            className="md:hidden p-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors"
                          >
                            <i className="fas fa-bars text-xl"></i>
                          </button>
                          <i className="fas fa-utensils text-2xl text-red-600"></i>
                          <h1 className="text-xl font-bold text-gray-800">é”‹å‘³æ´¾ç®¡ç†åå°</h1>
                        </div>
                        <div className="flex items-center gap-4">
                          <button 
                            onClick={() => setCurrentView('customer')} 
                            className="px-4 py-2 text-sm rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-700 flex items-center gap-2 transition-colors"
                          >
                            <i className="fas fa-store"></i>è¿”å›å®¢æˆ·ç«¯
                          </button>
                          <span className="text-sm text-gray-500 hidden sm:inline">ç®¡ç†å‘˜</span>
                          <button 
                            onClick={onLogout} 
                            className="px-4 py-2 text-sm rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors"
                          >
                            é€€å‡º
                          </button>
                        </div>
                      </div>
                    </header>
                    <div className="flex flex-1 relative">
                      {/* Sidebar overlay for mobile */}
                      {sidebarOpen && (
                        <div
                          className="fixed inset-0 bg-black/50 z-40 md:hidden"
                          onClick={() => setSidebarOpen(false)}
                        />
                      )}
                      
                      {/* Sidebar */}
                      <aside className={`
                        w-64 bg-white border-r shadow-sm transition-transform duration-300 ease-in-out
                        md:relative md:translate-x-0
                        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
                        fixed md:static top-0 left-0 h-full z-50 md:z-auto
                      `}>
                        <div className="flex justify-between items-center p-4 md:hidden border-b">
                          <span className="font-bold text-gray-800">èœå•</span>
                          <button 
                            onClick={() => setSidebarOpen(false)}
                            className="p-2 rounded-lg text-gray-600 hover:bg-gray-100"
                          >
                            <i className="fas fa-times"></i>
                          </button>
                        </div>
                        <nav className="p-4 space-y-2">
                          {[
                            {k:'dashboard', i:'chart-line', t:'ä»ªè¡¨æ¿'},
                            {k:'products', i:'pizza-slice', t:'äº§å“ç®¡ç†'},
                            {k:'inventory', i:'boxes', t:'åº“å­˜ç®¡ç†'},
                            {k:'orders', i:'list', t:'è®¢å•ç®¡ç†'},
                            {k:'scanner', i:'qrcode', t:'æ‰«ç åŠŸèƒ½'},
                            {k:'camera', i:'camera', t:'æ‹ç…§åŠŸèƒ½'},
                            {k:'analytics', i:'chart-pie', t:'æ•°æ®åˆ†æ'}
                          ].map(m => (
                            <button 
                              key={m.k} 
                              onClick={() => {
                                setView(m.k);
                                setSidebarOpen(false); // Close sidebar on mobile after selection
                              }} 
                              className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors ${
                                view === m.k ? 'bg-red-100 text-red-700' : 'text-gray-600 hover:bg-gray-100'
                              }`}
                            >
                              <i className={`fas fa-${m.i} w-5`}></i>
                              <span>{m.t}</span>
                            </button>
                          ))}
                        </nav>
                      </aside>
                      
                      <main className="flex-1 p-3 md:p-6 overflow-auto bg-gray-50">
                        {view === 'dashboard' && <Dashboard setView={setView}/>}
                        {view === 'products' && <Products/>}
                        {view === 'inventory' && <Inventory/>}
                        {view === 'orders' && <Orders/>}
                        {view === 'scanner' && <Scanner/>}
                        {view === 'camera' && <Camera/>}
                        {view === 'analytics' && <Analytics/>}
                      </main>
                    </div>
                  </div>
                );
              }

              // Chromeå…¼å®¹æ€§å¢å¼ºï¼šç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæ¯•
              function initializeApp() {
                // æ£€æŸ¥å¿…è¦çš„å…¨å±€å¯¹è±¡
                if (typeof React === 'undefined') {
                  console.error('React not loaded');
                  return;
                }
                if (typeof ReactDOM === 'undefined') {
                  console.error('ReactDOM not loaded');
                  return;
                }
                if (typeof window.supabase === 'undefined') {
                  console.error('Supabase not loaded');
                  return;
                }
                
                console.log('All dependencies loaded, initializing app...');
                console.log('App function:', typeof App, App);
                
                // Chromeå…¼å®¹æ€§å¢å¼ºï¼šä½¿ç”¨é”™è¯¯è¾¹ç•ŒåŒ…è£…App
                ReactDOM.render(
                  React.createElement(ErrorBoundary, null, 
                    React.createElement(App, null)
                  ), 
                  document.getElementById('root')
                );
              }
              
              // å»¶è¿Ÿåˆå§‹åŒ–ä»¥ç¡®ä¿èµ„æºåŠ è½½
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => setTimeout(initializeApp, 100));
              } else {
                setTimeout(initializeApp, 100);
              }
    </script>
</body>
</html>
