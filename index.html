<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FengWei Pai 管理后台系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        @keyframes slide-in-down { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-in-down { animation: slide-in-down 0.3s ease-out forwards; }
        @keyframes slide-in-right { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-slide-in-right { animation: slide-in-right 0.3s ease-out forwards; }
        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .toggle-checkbox:checked { right: 0; border-color: #48bb78; }
        .toggle-checkbox:checked + .toggle-label { background-color: #48bb78; }
        .hover-scale { transition: transform 0.2s ease-in-out; }
        .hover-scale:hover { transform: scale(1.02); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .card-shadow:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .gradient-bg { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        
        /* 全局字体增强样式 */
        * { font-weight: 600 !important; }
        body { font-size: 16px !important; font-weight: 600 !important; }
        h1 { font-size: 24px !important; font-weight: 700 !important; }
        h2 { font-size: 22px !important; font-weight: 700 !important; }
        h3 { font-size: 20px !important; font-weight: 700 !important; }
        h4 { font-size: 18px !important; font-weight: 700 !important; }
        table th { font-size: 16px !important; font-weight: 700 !important; }
        table td { font-size: 15px !important; font-weight: 600 !important; }
        button { font-size: 15px !important; font-weight: 700 !important; }
        input { font-size: 15px !important; font-weight: 600 !important; }
        select { font-size: 15px !important; font-weight: 600 !important; }
        .text-sm { font-size: 15px !important; font-weight: 600 !important; }
        .text-xs { font-size: 13px !important; font-weight: 600 !important; }
        label { font-weight: 700 !important; }
        span { font-weight: 600 !important; }
        div { font-weight: 600 !important; }
        p { font-weight: 600 !important; }
        a { font-weight: 600 !important; }
        .font-bold { font-weight: 800 !important; }
        .font-semibold { font-weight: 700 !important; }
        .font-medium { font-weight: 700 !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script type="text/babel">
      // Chrome兼容性检查
      if (typeof window.supabase === 'undefined') {
          console.error('Supabase not loaded. Please refresh the page.');
          document.body.innerHTML = '<div style="padding:20px;color:red;font-size:18px;">正在加载必要资源，请刷新页面...</div>';
      }
      
      // 迁移自 index.html 的全部 React 组件和功能
// 1. Supabase 配置与常量
const SUPABASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZm5oaHRoenRza3V1b3N1YXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTYxMTYsImV4cCI6MjA2NTU3MjExNn0.O3g2gjvsWagmWgmzoeJA8mPampvLYJr-KgqVwXsKoAo';
const WHATSAPP_NUMBER = '60162327792';
const ADMIN_PASSWORD = 'fengweipaiadmin';
const SELF_PICKUP_ADDRESS = `667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.`;
const PRODUCT_IMAGE_BASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/';
// 避免与全局 supabase UMD 对象同名遮蔽，显式引用 window.supabase
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// 为了向后兼容，也创建 supabase 别名
const supabase = supabaseClient;
// 解构 React Hooks 供后续直接使用
const { useState, useEffect, useCallback, useRef, useMemo } = React;

// Chrome兼容性增强：添加错误边界
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }
  
  componentDidCatch(error, errorInfo) {
    console.error('React Error:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return React.createElement('div', {
        style: { padding: '20px', color: 'red', fontSize: '18px' }
      }, '应用遇到错误，请刷新页面重试。错误信息: ' + (this.state.error?.message || '未知错误'));
    }
    return this.props.children;
  }
}

// ===== 通用工具函数 =====
function buildOrderMessage(order){
  try {
    let msg = `🛎️ *锋味派新订单 #${order.order_id}*\n\n`;
    msg += `👤 *客户信息*\n📛 姓名: ${order.name}\n📱 电话: ${order.phone}\n🚚 取货方式: ${order.delivery_method==='self-pickup'?'自取':'Lalamove送货'}\n`;
    msg += `\n🛒 *订单明细*\n`;
    (order.order_items||[]).forEach(it=>{
      const n=it.product||''; let emoji=it.emoji;
      if(!emoji){ if(n.includes('烤肠')) emoji='🌭'; else if(n.includes('虾')) emoji='🦐'; else if(n.includes('披萨')) emoji='🍕'; else if(n.includes('汤包')) emoji='🥟'; else if(n.includes('酥')) emoji='🥮'; else if(n.includes('鸡')) emoji='🍗'; else emoji='▫️'; }
      msg += `${emoji} ${it.product}${it.is_unlimited?' (预购)':' (现货)'} × ${it.quantity} = RM${(it.quantity*it.price).toFixed(2)}\n`;
    });
    msg += `\n💰 *总金额: RM${Number(order.total_amount).toFixed(2)}*\n📝 *备注*: ${order.remarks||'无'}\n`;
    msg += `📅 *下单时间*: ${(order.created_at? new Date(order.created_at):new Date()).toLocaleString('zh-CN')}`;
    return msg;
  } catch { return '订单信息生成失败'; }
}
async function copyTextUniversal(text){
  try{ 
    if(navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function'){ 
      await navigator.clipboard.writeText(text); 
      return true; 
    } 
  }catch{}
  try{ const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.top='-2000px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true;}catch{return false;}
}
function printOrder(order){
  const w=window.open('','_blank','width=820,height=900'); 
  if(!w){ alert('请允许弹窗'); return;}
  const doc = w.document;
  doc.open();
  doc.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>订单 ' + order.order_id + '</title>');
  doc.write('<style>body{font-family:Arial,system-ui;margin:16px;font-size:16px;font-weight:bold;}h1{font-size:28px;margin:0 0 12px;font-weight:bold;}div{font-size:16px;margin:6px 0;font-weight:bold;}table{width:100%;border-collapse:collapse;margin-top:12px;}th,td{border:2px solid #333;padding:8px;font-size:16px;font-weight:bold;}th{background:#f5f5f5;font-size:18px;} .total{font-weight:700;text-align:right;margin-top:12px;}@media print{@page{margin:10mm;}button{display:none}} .checkbox{width:20px;height:20px;border:3px solid #333;display:inline-block;margin-left:10px;}</style></head><body>');
  doc.write('<h1>锋味派订单 #' + order.order_id + '</h1>');
  doc.write('<div>客户: ' + order.name + ' (' + order.phone + ')</div>');
  doc.write('<div>方式: ' + (order.delivery_method==='self-pickup'?'自取':'Lalamove送货') + '</div>');
  doc.write('<div>备注: ' + (order.remarks||'无') + '</div>');
  doc.write('<table><thead><tr><th>商品</th><th style="width:120px;">数量 & 已打包</th></tr></thead><tbody>');
  (order.order_items||[]).forEach(function(i){
    doc.write('<tr><td>' + i.product + '</td><td style="text-align:center;">' + i.quantity + '<span class="checkbox"></span></td></tr>');
  });
  doc.write('</tbody></table>');
  doc.write('<div style="margin-top:16px; border-top:2px solid #333; padding-top:10px; font-size:14px; color:#666; font-weight:bold;">打包完成后请在数量旁边的勾选框内打勾 ✓</div>');
  doc.write('<button onclick="window.print()" style="font-size:16px;font-weight:bold;padding:10px 20px;margin-top:16px;">打印</button></body></html>');
  doc.close();
}

// ===== 基础 UI 组件 =====
function LoadingSpinner({text}){ return (<div style={{textAlign:'center',padding:'16px'}}><svg style={{height:'40px',width:'40px',color:'#dc2626',animation:'spin 1s linear infinite'}} viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" opacity="0.25"/><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" opacity="0.75"/></svg>{text&&<div style={{marginTop:'8px',fontSize:'14px',color:'#555'}}>{text}</div>}</div>); }
function Toast({message,type='success',onDismiss}){ useEffect(()=>{ const t=setTimeout(()=>onDismiss&&onDismiss(),2500); return()=>clearTimeout(t);},[onDismiss]); const colors={success:'#16a34a',danger:'#dc2626',warning:'#d97706'}; return <div style={{background:'#fff',border:'1px solid #e5e7eb',padding:'8px 12px',borderRadius:'8px',color:colors[type]||'#374151',boxShadow:'0 2px 6px rgba(0,0,0,0.08)',fontSize:'14px'}}>{message}</div>; }

      function LoginScreen({ onLogin }) {
        const [password, setPassword] = React.useState('');
        const [error, setError] = React.useState('');
        const handleSubmit = e => {
          e.preventDefault();
          if (password === 'fengweipaiadmin') {
            onLogin();
          } else {
            setError('密码错误，请重试');
          }
        };
        return (
          <div className="login-screen">
            <div className="login-container">
              <div className="login-header">
                <h1>FengWei Pai 管理后台</h1>
                <p>请输入管理员密码</p>
              </div>
              <form className="login-form" onSubmit={handleSubmit}>
                <div className="form-group">
                  <label className="form-label">管理员密码</label>
                  <input type="password" className="form-control" value={password} onChange={e => setPassword(e.target.value)} required />
                </div>
                <button type="submit" className="btn btn--primary btn--full-width">登录</button>
                {error && <div style={{color:'red',marginTop:'8px'}}>{error}</div>}
              </form>
            </div>
          </div>
        );
      }

      // Rename for consistency
      const Login = LoginScreen;

                    // === 客户端购物组件 ===
              const CustomerView = ({ products, cart, addToCart, updateCartQuantity, removeFromCart, cartTotal, totalItems, showToast, refreshProducts, isLoading, setLastOrder, setCart, onAdminClick }) => {
                const [isCartOpen, setIsCartOpen] = useState(false);
                const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
                const [isConfirmOpen, setIsConfirmOpen] = useState(false);
                const [orderData, setOrderData] = useState(null);
                const categories = useMemo(() => ['全部商品', ...new Set(products.map(p => p.category))], [products]);
                const [activeCategory, setActiveCategory] = useState('全部商品');
                const filteredProducts = useMemo(() => {
                  if (activeCategory === '全部商品') return products;
                  return products.filter(p => p.category === activeCategory);
                }, [products, activeCategory]);
                const handleOrderSuccess = (finalOrder) => {
                  if (typeof setCart === 'function') setCart([]);
                  setIsConfirmOpen(false);
                  setIsCheckoutOpen(false);
                  setLastOrder(finalOrder);
                  refreshProducts();
                };
                return (
                  <div>
                    <header className="bg-white shadow-md sticky top-0 z-40">
                      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between items-center py-4">
                          <div className="flex items-center gap-3">
                            <i className="fas fa-utensils text-3xl text-red-600"></i>
                            <h1 className="text-2xl font-bold text-gray-800">锋味派美食团购</h1>
                          </div>
                          <button onClick={onAdminClick} className="text-gray-600 hover:text-red-600 transition-all duration-200 group">
                            <div className="flex flex-col items-center">
                              <i className="fas fa-user-shield text-2xl group-hover:scale-110 transition-transform"></i>
                              <span className="text-xs mt-1 opacity-75 group-hover:opacity-100">管理</span>
                            </div>
                          </button>
                        </div>
                      </div>
                    </header>
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                      <div className="mb-8">
                        <div className="flex flex-wrap gap-2 justify-center">
                          {categories.map(category => (
                            <button
                              key={category}
                              onClick={() => setActiveCategory(category)}
                              className={`px-4 py-2 rounded-full font-medium transition-colors ${
                                activeCategory === category
                                  ? 'bg-red-600 text-white'
                                  : 'bg-white text-gray-700 hover:bg-red-100'
                              }`}
                            >
                              {category}
                            </button>
                          ))}
                        </div>
                      </div>
                      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-20">
                        {isLoading ? (
                          <p className="col-span-full text-center text-gray-500">加载中...</p>
                        ) : products.length === 0 ? (
                          <p className="col-span-full text-center text-gray-500">暂无商品，请联系管理员添加。</p>
                        ) : filteredProducts.length > 0 ? (
                          filteredProducts.map(product => (
                            <ProductCard key={product.id} product={product} onAddToCart={addToCart} />
                          ))
                        ) : (
                          <p className="col-span-full text-center text-gray-500">该分类下暂无商品。</p>
                        )}
                      </div>
                      {cart.length > 0 && (
                        <div className="fixed bottom-6 right-6 z-40">
                          <button onClick={() => setIsCartOpen(true)} className="gradient-bg text-white rounded-full p-4 shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-110 flex items-center gap-3 group">
                            <div className="relative">
                              <i className="fas fa-shopping-cart text-2xl group-hover:animate-bounce"></i>
                              <span className="absolute -top-2 -right-2 bg-yellow-400 text-black text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center animate-pulse">
                                {totalItems}
                              </span>
                            </div>
                            <div className="flex flex-col">
                              <span className="font-bold text-lg">RM{cartTotal.toFixed(2)}</span>
                              <span className="text-xs opacity-90">{totalItems} 件商品</span>
                            </div>
                          </button>
                        </div>
                      )}
                      <CartSidebar 
                        isOpen={isCartOpen}
                        cart={cart} 
                        updateQuantity={updateCartQuantity}
                        removeFromCart={removeFromCart}
                        totalPrice={cartTotal}
                        totalItems={totalItems}
                        onClose={() => setIsCartOpen(false)} 
                        onCheckout={() => { setIsCartOpen(false); setIsCheckoutOpen(true); }} 
                      />
                      {isCheckoutOpen && <CheckoutModal cart={cart} total={cartTotal} onClose={() => setIsCheckoutOpen(false)} onConfirm={(data) => { setOrderData(data); setIsCheckoutOpen(false); setIsConfirmOpen(true); }} showToast={showToast} />}
                      {isConfirmOpen && <ConfirmationModal orderData={orderData} onConfirm={handleOrderSuccess} onCancel={() => { setIsConfirmOpen(false); setIsCheckoutOpen(true); }} showToast={showToast} />}
                    </div>
                  </div>
                );
              };

              const ProductCard = ({ product, onAddToCart }) => {
                const isOutOfStock = !product.is_unlimited && product.stock === 0;
                const isLowStock = !product.is_unlimited && product.stock > 0 && product.minStock && product.stock <= product.minStock;
                const productTypeLabel = product.is_unlimited ? '(预购)' : '(现货)';
                return (
                  <div className={`bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 flex flex-col overflow-hidden hover-scale card-shadow ${isOutOfStock ? 'opacity-60 grayscale' : ''}`}>
                    <div className="relative">
                      <div className="w-full h-52 bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center overflow-hidden">
                        {product.image ? (
                          <img 
                            src={product.image} 
                            alt={product.name} 
                            className="w-full h-full object-cover hover:scale-110 transition-transform duration-300"
                            onError={(e) => {
                              e.target.style.display = 'none';
                              e.target.nextSibling.style.display = 'flex';
                            }}
                          />
                        ) : null}
                        <div className="w-full h-full flex items-center justify-center text-6xl bg-gradient-to-br from-red-50 to-red-100" style={{ display: product.image ? 'none' : 'flex' }}>
                          {product.emoji || '🍽️'}
                        </div>
                      </div>
                      {isOutOfStock && (
                        <div className="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center backdrop-blur-sm">
                          <div className="text-center">
                            <i className="fas fa-times-circle text-white text-3xl mb-2"></i>
                            <span className="text-white font-bold text-lg">已售完</span>
                          </div>
                        </div>
                      )}
                      {isLowStock && !isOutOfStock && (
                        <div className="absolute top-3 left-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg animate-pulse">
                          <i className="fas fa-exclamation-triangle mr-1"></i>低库存
                        </div>
                      )}
                      {product.is_unlimited && (
                        <div className="absolute top-3 right-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">
                          <i className="fas fa-infinity mr-1"></i>预购
                        </div>
                      )}
                    </div>
                    <div className="p-5 flex flex-col flex-grow">
                      <div className="mb-3">
                        <h3 className="text-lg font-bold text-gray-800 mb-1 line-clamp-2">{product.name}</h3>
                        <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{productTypeLabel}</span>
                      </div>
                      <div className="mb-4">
                        <div className="flex items-center justify-between text-sm text-gray-600">
                          <span className="flex items-center">
                            <i className="fas fa-warehouse mr-2 text-gray-400"></i>
                            库存: {product.is_unlimited ? '充足' : product.stock}
                          </span>
                          {product.category && (
                            <span className="bg-red-50 text-red-600 px-2 py-1 rounded text-xs">
                              {product.category}
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="mt-auto">
                        <div className="flex justify-between items-center">
                          <div>
                            <p className="text-2xl font-bold text-red-600 flex items-center">
                              RM{Number(product.price).toFixed(2)}
                              <span className="text-xs text-gray-500 ml-1">/件</span>
                            </p>
                          </div>
                          <button
                            onClick={() => onAddToCart(product)}
                            disabled={isOutOfStock}
                            className={`font-bold py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center gap-2 shadow-md ${
                              isOutOfStock 
                                ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                : 'bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white hover:shadow-lg transform hover:-translate-y-0.5'
                            }`}
                          >
                            <i className={`fas ${isOutOfStock ? 'fa-times' : 'fa-cart-plus'}`}></i>
                            {isOutOfStock ? '售罄' : '添加'}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              };

              const CartSidebar = ({ isOpen, cart, updateQuantity, removeFromCart, totalPrice, totalItems, onClose, onCheckout }) => {
                const handleQuantityChange = (item, newQuantity) => {
                  updateQuantity(item.id, newQuantity);
                };
                return (
                  <div>
                    <div
                      className={`fixed inset-0 bg-black/60 z-40 transition-opacity duration-300 ${
                        isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'
                      }`}
                      onClick={onClose}
                    />
                    <div
                      className={`fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-xl z-50 transform transition-transform duration-300 ${
                        isOpen ? 'translate-x-0' : 'translate-x-full'
                      } flex flex-col`}
                    >
                      <header className="flex items-center justify-between p-5 border-b">
                        <h2 className="text-xl font-bold text-gray-800">购物车</h2>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-800">
                          <i className="fas fa-times text-2xl"></i>
                        </button>
                      </header>
                      <div className="flex-1 overflow-y-auto p-5">
                        {cart.length === 0 ? (
                          <div className="text-center text-gray-500 mt-20">
                            <i className="fas fa-shopping-cart text-4xl mb-4"></i>
                            <p>购物车为空</p>
                          </div>
                        ) : (
                          <div className="space-y-4">
                            {cart.map(item => (
                              <div key={item.id} className="bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                                <div className="flex items-center gap-4">
                                  <div className="text-3xl flex-shrink-0">{item.emoji || '🍽️'}</div>
                                  <div className="flex-1 min-w-0">
                                    <h3 className="font-medium text-gray-800 truncate">{item.name}</h3>
                                    <div className="flex items-center gap-2">
                                      <p className="text-red-600 font-bold">RM{Number(item.price).toFixed(2)}</p>
                                      <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                        {item.is_unlimited ? '预购' : '现货'}
                                      </span>
                                      {!item.is_unlimited && (
                                        <span className="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                          库存: {item.stock_quantity || 0}
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                  <div className="flex flex-col items-end gap-2">
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={() => handleQuantityChange(item, item.quantity - 1)}
                                        className="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 hover:text-red-600 transition-colors"
                                      >
                                        <i className="fas fa-minus text-xs"></i>
                                      </button>
                                      <span className="w-8 text-center font-medium text-gray-800">{item.quantity}</span>
                                      <button
                                        onClick={() => handleQuantityChange(item, item.quantity + 1)}
                                        disabled={!item.is_unlimited && item.quantity >= (item.stock_quantity || 0)}
                                        className={`w-8 h-8 rounded-full flex items-center justify-center text-xs transition-colors ${
                                          !item.is_unlimited && item.quantity >= (item.stock_quantity || 0)
                                            ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                            : 'bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-red-600'
                                        }`}
                                      >
                                        <i className="fas fa-plus"></i>
                                      </button>
                                    </div>
                                    <button
                                      onClick={() => removeFromCart(item.id)}
                                      className="text-xs text-gray-400 hover:text-red-500 transition-colors"
                                    >
                                      <i className="fas fa-trash mr-1"></i>删除
                                    </button>
                                  </div>
                                </div>
                                <div className="mt-2 pt-2 border-t border-gray-100">
                                  <div className="flex justify-between items-center text-sm">
                                    <span className="text-gray-500">小计</span>
                                    <span className="font-bold text-gray-800">RM{(item.quantity * item.price).toFixed(2)}</span>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                      {cart.length > 0 && (
                        <footer className="border-t p-5 bg-white">
                          <div className="space-y-4">
                            <div className="flex justify-between items-center">
                              <span className="text-gray-600">商品总数:</span>
                              <span className="font-medium">{totalItems} 件</span>
                            </div>
                            <div className="flex justify-between items-center text-lg">
                              <span className="font-medium text-gray-800">总计:</span>
                              <span className="text-2xl font-bold text-red-600">RM{totalPrice.toFixed(2)}</span>
                            </div>
                            <button
                              onClick={onCheckout}
                              className="w-full gradient-bg text-white font-bold py-4 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center gap-2"
                            >
                              <i className="fas fa-credit-card"></i>
                              立即结账
                            </button>
                          </div>
                        </footer>
                      )}
                    </div>
                  </div>
                );
              };
              const CheckoutModal = ({ cart, total, onClose, onConfirm, showToast }) => {
                const [formData, setFormData] = useState({ name: '', phone: '', delivery: '', remarks: '', paymentMethod: '' });
                const [paymentProof, setPaymentProof] = useState(null);
                const [fileName, setFileName] = useState('');
                const [errors, setErrors] = useState({});
                const [agree, setAgree] = useState(false);
                const validate = () => {
                  const newErrors = {};
                  if (!agree) newErrors.agree = '请阅读并同意条款';
                  if (!formData.name) newErrors.name = '请输入姓名';
                  if (!formData.phone || !/^(\+?6?01)[0-46-9]-?[0-9]{7,8}$/.test(formData.phone)) newErrors.phone = '请输入有效的电话号码';
                  if (!formData.delivery) newErrors.delivery = '请选择取货方式';
                  if (!formData.paymentMethod) newErrors.paymentMethod = '请选择付款方式';
                  // Lalamove delivery requires address in remarks field
                  if (formData.delivery === 'lalamove' && (!formData.remarks || formData.remarks.trim() === '')) {
                    newErrors.remarks = 'Lalamove配送时备注栏不能为空，请填写配送地址';
                  }
                  if ((formData.paymentMethod === 'Maybank QR' || formData.paymentMethod === 'TNG eWallet') && !paymentProof) newErrors.paymentProof = '请上传支付凭证';
                  setErrors(newErrors);
                  return Object.keys(newErrors).length === 0;
                };
                const handleChange = (e) => {
                  const { name, value } = e.target;
                  setFormData(prev => ({ ...prev, [name]: value }));
                  if (errors[name]) setErrors(prev => ({ ...prev, [name]: null }));
                };
                const handleFileChange = (e) => {
                  const file = e.target.files[0];
                  if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                      showToast('文件大小不能超过5MB', 'danger');
                      return;
                    }
                    setPaymentProof(file);
                    setFileName(file.name);
                    if (errors.paymentProof) setErrors(prev => ({ ...prev, paymentProof: null }));
                  }
                };
                const handleNextStep = (e) => {
                  e.preventDefault();
                  if (validate()) {
                    onConfirm({ ...formData, paymentProof, cart, total });
                  }
                };
                return (
                  <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                      <div className="flex justify-between items-center p-5 border-b">
                        <h2 className="text-xl font-bold">结账</h2>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                      </div>
                      <div className="flex-1 overflow-y-auto p-5">
                        <form onSubmit={handleNextStep} className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">姓名 *</label>
                            <input type="text" name="name" value={formData.name} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="请输入您的姓名" />
                            {errors.name && <p className="text-red-500 text-xs mt-1">{errors.name}</p>}
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">电话号码 *</label>
                            <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="例如: 0123456789" />
                            {errors.phone && <p className="text-red-500 text-xs mt-1">{errors.phone}</p>}
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">取货方式 *</label>
                            <select name="delivery" value={formData.delivery} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                              <option value="">请选择取货方式</option>
                              <option value="self-pickup">自取</option>
                              <option value="lalamove">Lalamove送货</option>
                            </select>
                            {errors.delivery && <p className="text-red-500 text-xs mt-1">{errors.delivery}</p>}
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">付款方式 *</label>
                            <select name="paymentMethod" value={formData.paymentMethod} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                              <option value="">请选择付款方式</option>
                              <option value="Maybank QR">Maybank QR</option>
                              <option value="TNG eWallet">TNG eWallet</option>
                            </select>
                            {errors.paymentMethod && <p className="text-red-500 text-xs mt-1">{errors.paymentMethod}</p>}
                          </div>
                          {(formData.paymentMethod === 'Maybank QR' || formData.paymentMethod === 'TNG eWallet') && (
                            <>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">支付二维码</label>
                                <div className="flex justify-center p-4 bg-gray-50 rounded-lg">
                                  {formData.paymentMethod === 'Maybank QR' && (
                                    <img 
                                      src="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/IMG_4042.png" 
                                      alt="Maybank QR码" 
                                      className="max-w-xs max-h-64 object-contain"
                                    />
                                  )}
                                  {formData.paymentMethod === 'TNG eWallet' && (
                                    <img 
                                      src="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/IMG_4043.jpeg" 
                                      alt="TNG eWallet二维码" 
                                      className="max-w-xs max-h-64 object-contain"
                                    />
                                  )}
                                </div>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">上传支付凭证 *</label>
                                <input type="file" onChange={handleFileChange} accept="image/*,.pdf" className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" />
                                {fileName && <p className="text-green-600 text-xs mt-1">已选择: {fileName}</p>}
                                {errors.paymentProof && <p className="text-red-500 text-xs mt-1">{errors.paymentProof}</p>}
                              </div>
                            </>
                          )}
                          
                          {/* Self-pickup address display */}
                          {formData.delivery === 'self-pickup' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">自取地址</label>
                              <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700">
                                {SELF_PICKUP_ADDRESS}
                              </div>
                              <p className="text-gray-500 text-xs mt-1">自取地址为只读，无需填写</p>
                            </div>
                          )}
                          
                          {/* Remarks field - required for Lalamove, optional for self-pickup */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              备注 {formData.delivery === 'lalamove' && <span className="text-red-500">*</span>}
                            </label>
                            <textarea 
                              name="remarks" 
                              value={formData.remarks} 
                              onChange={handleChange} 
                              rows="3" 
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" 
                              placeholder={formData.delivery === 'lalamove' ? '请在此填写配送地址（必填）' : '如有特殊要求，请在此说明'}
                            />
                            {errors.remarks && <p className="text-red-500 text-xs mt-1">{errors.remarks}</p>}
                          </div>
                          <div className="flex items-start gap-2">
                            <input type="checkbox" checked={agree} onChange={(e) => setAgree(e.target.checked)} className="mt-1" />
                            <label className="text-sm text-gray-600">
                              我已阅读并同意<a href="#" className="text-red-600 underline">服务条款</a>和<a href="#" className="text-red-600 underline">隐私政策</a>
                            </label>
                          </div>
                          {errors.agree && <p className="text-red-500 text-xs">{errors.agree}</p>}
                        </form>
                      </div>
                      <div className="p-5 border-t">
                        <div className="flex justify-between items-center mb-4">
                          <span className="text-lg font-medium">订单总计:</span>
                          <span className="text-2xl font-bold text-red-600">RM{total.toFixed(2)}</span>
                        </div>
                        <button onClick={handleNextStep} className="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors">
                          确认订单
                        </button>
                      </div>
                    </div>
                  </div>
                );
              };

              // 生成旧版格式的订单号：FW+YYYYMMDD+三位流水号
              const generateOrderId = async () => {
                const today = new Date();
                const dateStr = today.getFullYear().toString() + 
                                (today.getMonth() + 1).toString().padStart(2, '0') + 
                                today.getDate().toString().padStart(2, '0');
                
                // 获取今天已有的订单来确定流水号
                const { data: todayOrders } = await supabaseClient
                  .from('orders')
                  .select('order_id')
                  .ilike('order_id', `FW${dateStr}%`)
                  .order('order_id', { ascending: false })
                  .limit(1);
                
                let sequenceNumber = 1;
                if (todayOrders && todayOrders.length > 0) {
                  const lastOrderId = todayOrders[0].order_id;
                  const lastSequence = parseInt(lastOrderId.substring(10)); // 取最后3位数字
                  sequenceNumber = lastSequence + 1;
                }
                
                return `FW${dateStr}${sequenceNumber.toString().padStart(3, '0')}`;
              };

              const ConfirmationModal = ({ orderData, onConfirm, onCancel, showToast }) => {
                const [isSubmitting, setIsSubmitting] = useState(false);
                const handleSubmit = async () => {
                  setIsSubmitting(true);
                  try {
                    const { paymentProof, cart, total, ...formData } = orderData;
                    
                    // Validate stock availability before submitting order
                    for (const item of cart) {
                      if (!item.is_unlimited) {
                        const { data: productData, error: productError } = await supabaseClient
                          .from('products')
                          .select('stock_quantity')
                          .eq('id', item.id)
                          .single();
                          
                        if (productError) {
                          throw new Error(`获取商品库存失败: ${productError.message}`);
                        }
                        
                        const currentStock = productData.stock_quantity ?? 0;
                        if (item.quantity > currentStock) {
                          throw new Error(`商品"${item.name}"库存不足，当前库存：${currentStock}件，订单需要：${item.quantity}件`);
                        }
                      }
                    }
                    
                    // 生成新格式的订单号
                    const orderId = await generateOrderId();
                    
                    const orderInsertData = {
                      order_id: orderId,
                      name: formData.name,
                      phone: formData.phone,
                      delivery_method: formData.delivery,
                      remarks: formData.remarks || '',
                      payment_method: formData.paymentMethod,
                      total_amount: total,
                      status: 'pending',
                      order_items: cart.map(item => ({
                        product: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        emoji: item.emoji,
                        is_unlimited: item.is_unlimited
                      })),
                      created_at: new Date().toISOString()
                    };
                    let paymentProofUrl = null;
                    if (paymentProof) {
                      const fileName = 'payment-proof-' + Date.now() + '.' + paymentProof.name.split('.').pop();
                      const { error: uploadError } = await supabaseClient.storage.from('payment-proofs').upload(fileName, paymentProof);
                      if (uploadError) {
                        throw new Error('上传支付凭证失败: ' + uploadError.message);
                      }
                      const { data: { publicUrl } } = supabaseClient.storage.from('payment-proofs').getPublicUrl(fileName);
                      paymentProofUrl = publicUrl;
                    }
                    if (paymentProofUrl) {
                      orderInsertData.payment_proof_url = paymentProofUrl;
                    }
                    const { data: insertedOrder, error: insertError } = await supabaseClient.from('orders').insert([orderInsertData]).select().single();
                    if (insertError) throw insertError;
                    for (const item of cart) {
                      if (!item.is_unlimited && item.stock_quantity !== undefined) {
                        const newStock = Math.max(0, item.stock_quantity - item.quantity);
                        await supabaseClient.from('products').update({ stock_quantity: newStock }).eq('id', item.id);
                      }
                    }
                    showToast('订单提交成功！', 'success');
                    onConfirm(insertedOrder);
                  } catch (error) {
                    console.error('订单提交失败:', error);
                    showToast('订单提交失败: ' + error.message, 'danger');
                  } finally {
                    setIsSubmitting(false);
                  }
                };
                return (
                  <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                      <div className="flex justify-between items-center p-5 border-b">
                        <h2 className="text-xl font-bold">确认订单</h2>
                        <button onClick={onCancel} disabled={isSubmitting} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                      </div>
                      <div className="flex-1 overflow-y-auto p-5">
                        <div className="space-y-4">
                          <div>
                            <h3 className="font-medium text-gray-800 mb-2">客户信息</h3>
                            <p>姓名: {orderData.name}</p>
                            <p>电话: {orderData.phone}</p>
                            <p>取货方式: {orderData.delivery === 'self-pickup' ? '自取' : 'Lalamove送货'}</p>
                            <p>付款方式: {orderData.paymentMethod}</p>
                            {orderData.remarks && <p>备注: {orderData.remarks}</p>}
                          </div>
                          <div>
                            <h3 className="font-medium text-gray-800 mb-2">订单明细</h3>
                            {orderData.cart.map(item => (
                              <div key={item.id} className="flex justify-between items-center py-2 border-b">
                                <span>{item.emoji} {item.name} × {item.quantity}</span>
                                <span>RM{(item.price * item.quantity).toFixed(2)}</span>
                              </div>
                            ))}
                            <div className="flex justify-between items-center py-2 font-bold text-lg">
                              <span>总计:</span>
                              <span className="text-red-600">RM{orderData.total.toFixed(2)}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div className="p-5 border-t flex gap-3">
                        <button onClick={onCancel} disabled={isSubmitting} className="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">
                          返回修改
                        </button>
                        <button onClick={handleSubmit} disabled={isSubmitting} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-400">
                          {isSubmitting ? '提交中...' : '确认并提交'}
                        </button>
                      </div>
                    </div>
                  </div>
                );
              };

              const OrderSuccessModal = ({ order, onNewOrder }) => {
                const [showDialog, setShowDialog] = useState(true);
                const [showSuccess, setShowSuccess] = useState(false);
                const [hasRedirected, setHasRedirected] = useState(false);
                const buildWhatsAppMessage = useCallback(() => {
                  try {
                    let msg = '🛎️ *锋味派新订单 #' + order.order_id + '*\n\n';
                    msg += '👤 *客户信息*\n';
                    msg += '📛 姓名: ' + order.name + '\n';
                    msg += '📱 电话: ' + order.phone + '\n';
                    msg += '🚚 取货方式: ' + (order.delivery_method === 'self-pickup' ? '自取' : 'Lalamove送货') + '\n';
                    if (order.delivery_method === 'self-pickup') {
                      msg += '📍 自取地址: 667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.\n';
                      msg += '⏰ 取货时间: 另行通知\n';
                      msg += '📞 联络号码: 0162327792\n';
                    }
                    msg += '\n🛒 *订单明细*\n';
                    if (Array.isArray(order.order_items)) {
                      order.order_items.forEach(item => {
                        let emoji = item.emoji;
                        if (!emoji) {
                          const n = item.product || '';
                          if (n.includes('烤肠')) emoji = '🌭';
                          else if (n.includes('虾')) emoji = '🦐';
                          else if (n.includes('披萨')) emoji = '🍕';
                          else if (n.includes('汤包')) emoji = '🥟';
                          else if (n.includes('酥饼')) emoji = '🥮';
                          else if (n.includes('鸡排') || n.includes('鸡翅')) emoji = '🍗';
                          else emoji = '▫️';
                        }
                        const typeLabel = item.is_unlimited ? ' (预购)' : ' (现货)';
                        msg += emoji + ' ' + item.product + typeLabel + ' × ' + item.quantity + ' = RM' + (item.quantity * item.price).toFixed(2) + '\n';
                      });
                    }
                    msg += '\n💰 *总金额: RM' + Number(order.total_amount).toFixed(2) + '*\n';
                    msg += '📝 *备注*: ' + (order.remarks || '无') + '\n';
                    const createdAt = order.created_at ? new Date(order.created_at) : new Date();
                    msg += '📅 *下单时间*: ' + createdAt.toLocaleString('zh-CN');
                    return msg;
                  } catch (e) {
                    console.error('[buildWhatsAppMessage] error:', e, order);
                    return '订单信息生成失败，请联系管理员。';
                  }
                }, [order]);
                const whatsappMsg = buildWhatsAppMessage();
                const whatsappUrl = 'https://wa.me/60162327792?text=' + encodeURIComponent(whatsappMsg);
                const handleCopy = useCallback(async () => {
                  try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                      await navigator.clipboard.writeText(whatsappMsg);
                      alert('订单信息已复制到剪贴板');
                    } else {
                      const ta = document.createElement('textarea');
                      ta.value = whatsappMsg;
                      ta.style.position = 'fixed';
                      ta.style.top = '-2000px';
                      document.body.appendChild(ta);
                      ta.select();
                      document.execCommand('copy');
                      document.body.removeChild(ta);
                      alert('订单信息已复制到剪贴板');
                    }
                  } catch (err) {
                    window.alert('复制失败，请长按选择手动复制。');
                    console.error('[OrderSuccessModal] Clipboard copy error:', err);
                  }
                }, [whatsappMsg]);
                const handleSend = useCallback(() => {
                  setShowDialog(false);
                  setShowSuccess(true);
                }, []);
                const handleSuccessConfirm = useCallback(() => {
                  try {
                    if (!hasRedirected) {
                      setHasRedirected(true);
                      window.location.href = whatsappUrl;
                    }
                  } catch (err) {
                    window.alert('跳转WhatsApp失败，请手动发送订单信息。');
                    console.error('[OrderSuccessModal] WhatsApp redirect error:', err);
                  }
                  setShowSuccess(false);
                  onNewOrder();
                }, [hasRedirected, whatsappUrl, onNewOrder]);
                if (showDialog) {
                  return (
                    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                      <div className="bg-white rounded-lg shadow-xl w-full max-w-md text-center animate-fade-in">
                        <div className="p-6">
                          <i className="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                          <h2 className="text-2xl font-bold mb-4">订单提交成功!</h2>
                          <div className="bg-gray-100 p-4 rounded-lg mb-4 text-left text-sm max-h-40 overflow-y-auto">
                            <pre className="whitespace-pre-wrap font-mono text-xs">{whatsappMsg}</pre>
                          </div>
                          <p className="text-gray-600 mb-4">请点击"发送到WhatsApp"将订单信息发送给我们，或先"复制订单"手动发送。</p>
                          <div className="space-y-2">
                            <button onClick={handleSend} className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                              <i className="fab fa-whatsapp"></i> 发送到WhatsApp
                            </button>
                            <button onClick={handleCopy} className="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                              复制订单信息
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                }
                if (showSuccess) {
                  return (
                    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                      <div className="bg-white rounded-lg shadow-xl w-full max-w-md text-center animate-fade-in">
                        <div className="p-6">
                          <i className="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                          <h2 className="text-2xl font-bold mb-2">订单提交成功!</h2>
                          <p className="text-gray-600 mb-4">订单已成功保存，请点击"好的"跳转到WhatsApp发送订单信息。</p>
                          <button onClick={handleSuccessConfirm} className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors mb-3">好的 (OK)</button>
                        </div>
                      </div>
                    </div>
                  );
                }
                return null;
              };

              const LoadingOverlay = ({ text }) => (
                <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50">
                  <div className="bg-white p-8 rounded-lg shadow-xl text-center">
                    <LoadingSpinner text={text} />
                  </div>
                </div>
              );

              function Dashboard({ setView }) {
                const [stats, setStats] = useState({
                  todaySales: 0,
                  monthSales: 0,
                  todayOrders: 0,
                  pendingOrders: 0,
                  availableProducts: 0,
                  lowStock: 0,
                  totalStock: 0,
                  stockValue: 0
                });

                const [presaleStats, setPresaleStats] = useState({
                  totalBoxes: 0,
                  completedGroups: 0,
                  remainingBoxes: 0
                });

                useEffect(() => {
                  const fetchStats = async () => {
                    try {
                      // 获取今日订单
                      const today = new Date().toISOString().slice(0, 10);
                      const { data: todayOrders } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .gte('created_at', today + 'T00:00:00');

                      // 获取本月订单
                      const monthStart = new Date();
                      monthStart.setDate(1);
                      const { data: monthOrders } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .gte('created_at', monthStart.toISOString());

                      // 获取待处理订单
                      const { data: pendingOrders } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .eq('status', 'pending');

                      // 获取商品库存信息
                      const { data: products } = await supabaseClient
                        .from('products')
                        .select('*');

                      // 获取所有订单用于预售统计
                      const { data: allOrders } = await supabaseClient
                        .from('orders')
                        .select('*, order_items(*)');

                      // 计算预售成团统计
                      let totalPresaleBoxes = 0;
                      if (allOrders) {
                        allOrders.forEach(order => {
                          if (order.order_items) {
                            order.order_items.forEach(item => {
                              // 排除现货和运费专用商品
                              if (item.product && 
                                  !item.product.includes('运费') && 
                                  item.product !== '运费专用') {
                                // 查找对应的产品信息
                                const product = products?.find(p => p.name === item.product);
                                // 只统计预售商品（is_unlimited为true的商品）
                                if (product && product.is_unlimited) {
                                  totalPresaleBoxes += item.quantity || 0;
                                }
                              }
                            });
                          }
                        });
                      }

                      const completedGroups = Math.floor(totalPresaleBoxes / 200);
                      const remainingBoxes = 200 - (totalPresaleBoxes % 200);

                      setPresaleStats({
                        totalBoxes: totalPresaleBoxes,
                        completedGroups,
                        remainingBoxes: remainingBoxes === 200 ? 0 : remainingBoxes
                      });

                      const todaySales = (todayOrders || []).reduce((sum, order) => sum + Number(order.total_amount), 0);
                      const monthSales = (monthOrders || []).reduce((sum, order) => sum + Number(order.total_amount), 0);
                      // 总库存只计算现货商品（非预购商品）的库存数量
                      const totalStock = (products || [])
                        .filter(p => !p.is_unlimited) // 只计算非预购商品
                        .reduce((sum, p) => sum + (p.stock_quantity || 0), 0);
                      // 库存价值也只计算现货商品
                      const stockValue = (products || [])
                        .filter(p => !p.is_unlimited)
                        .reduce((sum, p) => sum + ((p.stock_quantity || 0) * (p.price || 0)), 0);
                      const lowStockCount = (products || []).filter(p => (p.stock_quantity || 0) <= (p.min_stock_threshold || 5)).length;

                      setStats({
                        todaySales,
                        monthSales,
                        todayOrders: (todayOrders || []).length,
                        pendingOrders: (pendingOrders || []).length,
                        availableProducts: (products || []).filter(p => p.is_published).length,
                        lowStock: lowStockCount,
                        totalStock,
                        stockValue
                      });
                    } catch (error) {
                      console.error('获取统计数据失败:', error);
                    }
                  };

                  fetchStats();
                }, []);

                return (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800">仪表板</h2>
                    
                    {/* 预售成团统计 */}
                    <div className="bg-gradient-to-r from-pink-500 to-rose-500 rounded-lg shadow-lg text-white p-6">
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                          <i className="fas fa-users text-2xl"></i>
                          <h3 className="text-xl font-bold">预售成团统计</h3>
                        </div>
                        <div className="text-sm bg-white/20 px-3 py-1 rounded-full">
                          每200盒成团
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white/10 rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium opacity-90">已成团数</p>
                              <p className="text-2xl font-bold">{presaleStats.completedGroups}团</p>
                            </div>
                            <i className="fas fa-check-circle text-2xl opacity-80"></i>
                          </div>
                        </div>
                        <div className="bg-white/10 rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium opacity-90">总售出数量</p>
                              <p className="text-2xl font-bold">{presaleStats.totalBoxes}盒</p>
                            </div>
                            <i className="fas fa-box text-2xl opacity-80"></i>
                          </div>
                        </div>
                        <div className="bg-white/10 rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium opacity-90">下一团还需</p>
                              <p className="text-2xl font-bold">{presaleStats.remainingBoxes}盒</p>
                            </div>
                            <i className="fas fa-hourglass-half text-2xl opacity-80"></i>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* 统计卡片 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">今日销售额</h3>
                            <p className="text-2xl font-bold text-green-600">RM{stats.todaySales.toFixed(2)}</p>
                          </div>
                          <i className="fas fa-chart-line text-3xl text-green-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">本月销售额</h3>
                            <p className="text-2xl font-bold text-blue-600">RM{stats.monthSales.toFixed(2)}</p>
                          </div>
                          <i className="fas fa-calendar-alt text-3xl text-blue-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">今日订单</h3>
                            <p className="text-2xl font-bold text-purple-600">{stats.todayOrders}</p>
                          </div>
                          <i className="fas fa-shopping-cart text-3xl text-purple-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">待处理订单</h3>
                            <p className="text-2xl font-bold text-orange-600">{stats.pendingOrders}</p>
                          </div>
                          <i className="fas fa-clock text-3xl text-orange-500"></i>
                        </div>
                      </div>
                    </div>

                    {/* 库存概览 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">上架商品</h3>
                            <p className="text-2xl font-bold text-indigo-600">{stats.availableProducts}</p>
                          </div>
                          <i className="fas fa-store text-3xl text-indigo-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow cursor-pointer hover:bg-gray-50" onClick={() => setView('inventory')}>
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">总库存</h3>
                            <p className="text-2xl font-bold text-teal-600">{stats.totalStock}</p>
                          </div>
                          <i className="fas fa-boxes text-3xl text-teal-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow cursor-pointer hover:bg-gray-50" onClick={() => setView('inventory')}>
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">库存价值</h3>
                            <p className="text-2xl font-bold text-emerald-600">RM{stats.stockValue.toFixed(2)}</p>
                          </div>
                          <i className="fas fa-dollar-sign text-3xl text-emerald-500"></i>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow cursor-pointer hover:bg-gray-50" onClick={() => setView('inventory')}>
                        <div className="flex items-center">
                          <div className="flex-1">
                            <h3 className="text-sm font-medium text-gray-500">低库存商品</h3>
                            <p className="text-2xl font-bold text-red-600">{stats.lowStock}</p>
                          </div>
                          <i className="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                        </div>
                      </div>
                    </div>

                    {/* 快捷操作 */}
                    <div className="bg-white p-6 rounded-lg shadow">
                      <h3 className="text-lg font-semibold mb-4">快捷操作</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onClick={() => setView('orders')} className="flex flex-col items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                          <i className="fas fa-list text-2xl text-blue-600 mb-2"></i>
                          <span className="text-sm font-medium text-blue-700">查看订单</span>
                        </button>
                        
                        <button onClick={() => setView('products')} className="flex flex-col items-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                          <i className="fas fa-pizza-slice text-2xl text-green-600 mb-2"></i>
                          <span className="text-sm font-medium text-green-700">管理商品</span>
                        </button>
                        
                        <button onClick={() => setView('inventory')} className="flex flex-col items-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                          <i className="fas fa-boxes text-2xl text-purple-600 mb-2"></i>
                          <span className="text-sm font-medium text-purple-700">库存管理</span>
                        </button>
                        
                        <button onClick={() => setView('analytics')} className="flex flex-col items-center p-4 bg-orange-50 hover:bg-orange-100 rounded-lg transition-colors">
                          <i className="fas fa-chart-pie text-2xl text-orange-600 mb-2"></i>
                          <span className="text-sm font-medium text-orange-700">数据分析</span>
                        </button>
                      </div>
                    </div>
                  </div>
                );
              }
              // ========= 产品管理 =========
              function Products() {
                const [products, setProducts] = useState([]);
                const [search, setSearch] = useState('');
                const [cat, setCat] = useState('');
                const [loading, setLoading] = useState(true);
                const [editingProduct, setEditingProduct] = useState(null);
                const [showAddForm, setShowAddForm] = useState(false);
                const [toast, setToast] = useState(null);

                const showToast = (message, type = 'success') => {
                  setToast({ message, type });
                  setTimeout(() => setToast(null), 3000);
                };

                const fetchProducts = async () => {
                  setLoading(true);
                  const { data, error } = await supabaseClient.from('products').select('*').order('id');
                  if (error) {
                    showToast('加载产品失败: ' + error.message, 'danger');
                  } else {
                    setProducts(data || []);
                  }
                  setLoading(false);
                };

                useEffect(() => {
                  fetchProducts();
                }, []);

                const cats = [...new Set(products.map(p => p.category).filter(Boolean))];
                const filtered = products.filter(p => 
                  (!search || p.name.toLowerCase().includes(search.toLowerCase())) && 
                  (!cat || p.category === cat)
                );

                const handleEdit = (product) => {
                  setEditingProduct({ ...product });
                };

                const handleSave = async (product) => {
                  const { error } = await supabaseClient
                    .from('products')
                    .update({
                      name: product.name,
                      price: Number(product.price),
                      category: product.category,
                      emoji: product.emoji,
                      stock_quantity: product.is_unlimited ? null : Number(product.stock_quantity || 0),
                      min_stock_threshold: Number(product.min_stock_threshold || 5),
                      is_unlimited: product.is_unlimited,
                      is_published: product.is_published,
                      status: product.status || 'active',
                      image_url: product.image_url || null
                    })
                    .eq('id', product.id);

                  if (error) {
                    showToast('保存失败: ' + error.message, 'danger');
                  } else {
                    showToast('保存成功', 'success');
                    setEditingProduct(null);
                    fetchProducts();
                  }
                };

                const handleDelete = async (id) => {
                  if (confirm('确定要删除这个产品吗？')) {
                    const { error } = await supabaseClient.from('products').delete().eq('id', id);
                    if (error) {
                      showToast('删除失败: ' + error.message, 'danger');
                    } else {
                      showToast('删除成功', 'success');
                      fetchProducts();
                    }
                  }
                };

                const handleAddProduct = async (productData) => {
                  const { error } = await supabaseClient
                    .from('products')
                    .insert([{
                      name: productData.name,
                      price: Number(productData.price),
                      category: productData.category || null,
                      emoji: productData.emoji || '🍽️',
                      stock_quantity: productData.is_unlimited ? null : Number(productData.stock_quantity || 0),
                      min_stock_threshold: Number(productData.min_stock_threshold || 5),
                      is_unlimited: productData.is_unlimited || false,
                      is_published: productData.is_published || false,
                      status: productData.status || 'active',
                      image_url: productData.image_url || null
                    }]);

                  if (error) {
                    showToast('添加失败: ' + error.message, 'danger');
                  } else {
                    showToast('添加成功', 'success');
                    setShowAddForm(false);
                    fetchProducts();
                  }
                };

                if (loading) {
                  return <LoadingSpinner text="加载产品数据..." />;
                }

                return (
                  <div className="bg-white p-6 rounded-lg shadow">
                    <div className="flex flex-wrap gap-3 items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <h2 className="text-lg font-bold">产品管理 ({products.length})</h2>
                        <button
                          onClick={() => setShowAddForm(true)}
                          className="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                        >
                          <i className="fas fa-plus mr-1"></i>添加产品
                        </button>
                      </div>
                      <div className="flex gap-2">
                        <input
                          value={search}
                          onChange={e => setSearch(e.target.value)}
                          placeholder="搜索产品"
                          className="border px-3 py-1.5 rounded text-sm"
                        />
                        <select
                          value={cat}
                          onChange={e => setCat(e.target.value)}
                          className="border px-3 py-1.5 rounded text-sm"
                        >
                          <option value="">全部分类</option>
                          {cats.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                        <button
                          onClick={fetchProducts}
                          className="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-sm"
                        >
                          <i className="fas fa-sync-alt"></i>
                        </button>
                      </div>
                    </div>

                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-gray-50">
                            <th className="p-3 text-left">商品</th>
                            <th className="p-3 text-left">价格</th>
                            <th className="p-3 text-left">库存</th>
                            <th className="p-3 text-left">分类</th>
                            <th className="p-3 text-left">类型</th>
                            <th className="p-3 text-left">状态</th>
                            <th className="p-3 text-left">上架</th>
                            <th className="p-3 text-left">操作</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filtered.map(p => (
                            <tr key={p.id} className="border-b hover:bg-gray-50">
                              <td className="p-3">
                                <div className="flex items-center gap-2">
                                  <span className="text-lg">{p.emoji || '🍽️'}</span>
                                  <span className="font-medium">{p.name}</span>
                                </div>
                              </td>
                              <td className="p-3">RM{Number(p.price || 0).toFixed(2)}</td>
                              <td className="p-3">
                                {p.is_unlimited ? (
                                  <span className="text-blue-600 font-medium">无限制</span>
                                ) : (
                                  <span className={`font-medium ${
                                    (p.stock_quantity ?? 0) === 0 ? 'text-red-600' :
                                    (p.stock_quantity ?? 0) <= (p.min_stock_threshold ?? 5) ? 'text-orange-600' :
                                    'text-green-600'
                                  }`}>
                                    {p.stock_quantity ?? 0}
                                  </span>
                                )}
                              </td>
                              <td className="p-3">{p.category || '-'}</td>
                              <td className="p-3">
                                <span className={`px-2 py-1 rounded-full text-xs ${
                                  p.is_unlimited 
                                    ? 'bg-blue-100 text-blue-800' 
                                    : 'bg-green-100 text-green-800'
                                }`}>
                                  {p.is_unlimited ? '预购' : '现货'}
                                </span>
                              </td>
                              <td className="p-3">
                                <span className={`px-2 py-1 rounded-full text-xs ${
                                  p.status === 'active' 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-red-100 text-red-800'
                                }`}>
                                  {p.status === 'active' ? '正常' : '暂停'}
                                </span>
                              </td>
                              <td className="p-3">
                                <span className={`px-2 py-1 rounded-full text-xs ${
                                  p.is_published 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-gray-100 text-gray-800'
                                }`}>
                                  {p.is_published ? '已上架' : '已下架'}
                                </span>
                              </td>
                              <td className="p-3">
                                <div className="flex gap-1">
                                  <button
                                    onClick={() => handleEdit(p)}
                                    className="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                                  >
                                    编辑
                                  </button>
                                  <button
                                    onClick={() => handleDelete(p.id)}
                                    className="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                                  >
                                    删除
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {filtered.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                          <i className="fas fa-search text-4xl mb-2"></i>
                          <p>没有找到符合条件的产品</p>
                        </div>
                      )}
                    </div>

                    {/* 编辑产品模态框 */}
                    {editingProduct && (
                      <ProductEditModal
                        product={editingProduct}
                        onSave={handleSave}
                        onCancel={() => setEditingProduct(null)}
                        showToast={showToast}
                      />
                    )}

                    {/* 添加产品模态框 */}
                    {showAddForm && (
                      <ProductAddModal
                        onSave={handleAddProduct}
                        onCancel={() => setShowAddForm(false)}
                        showToast={showToast}
                      />
                    )}

                    {toast && (
                      <div className="fixed top-4 right-4 z-50">
                        <Toast {...toast} onDismiss={() => setToast(null)} />
                      </div>
                    )}
                  </div>
                );
              }

              // 产品编辑模态框组件
              const ProductEditModal = ({ product, onSave, onCancel, showToast }) => {
                const [formData, setFormData] = useState({ ...product });
                const [uploading, setUploading] = useState(false);

                const handleChange = (field, value) => {
                  setFormData(prev => ({ ...prev, [field]: value }));
                };

                const handleImageUpload = async (file) => {
                  if (!file) return;
                  
                  setUploading(true);
                  try {
                    const ext = file.name.split('.').pop();
                    const filename = `products/${Date.now()}-${Math.random().toString(36).substring(7)}.${ext}`;
                    
                    const { error: uploadError } = await supabaseClient.storage
                      .from('product-photos')
                      .upload(filename, file);
                    
                    if (uploadError) {
                      showToast('图片上传失败: ' + uploadError.message, 'danger');
                      return;
                    }
                    
                    const { data: { publicUrl } } = supabaseClient.storage
                      .from('product-photos')
                      .getPublicUrl(filename);
                    
                    handleChange('image_url', publicUrl);
                    showToast('图片上传成功', 'success');
                  } catch (error) {
                    showToast('上传异常: ' + error.message, 'danger');
                  }
                  setUploading(false);
                };

                const handleSubmit = () => {
                  if (!formData.name || !formData.price) {
                    showToast('请填写商品名称和价格', 'danger');
                    return;
                  }
                  onSave(formData);
                };

                return (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                      <div className="flex justify-between items-center p-4 border-b">
                        <h3 className="text-lg font-bold">编辑产品</h3>
                        <button onClick={onCancel} className="text-gray-500 hover:text-gray-700">
                          <i className="fas fa-times"></i>
                        </button>
                      </div>
                      
                      <div className="p-6 space-y-4">
                        <div className="grid md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">商品名称 *</label>
                            <input
                              type="text"
                              value={formData.name || ''}
                              onChange={e => handleChange('name', e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">表情符号</label>
                            <input
                              type="text"
                              value={formData.emoji || ''}
                              onChange={e => handleChange('emoji', e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="🍽️"
                            />
                          </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">价格 (RM) *</label>
                            <input
                              type="number"
                              step="0.01"
                              value={formData.price || ''}
                              onChange={e => handleChange('price', e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">分类</label>
                            <input
                              type="text"
                              value={formData.category || ''}
                              onChange={e => handleChange('category', e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-1">商品图片</label>
                          <div className="flex items-center gap-4">
                            <input
                              type="file"
                              accept="image/*"
                              onChange={e => e.target.files[0] && handleImageUpload(e.target.files[0])}
                              className="hidden"
                              id="image-upload-edit"
                              disabled={uploading}
                            />
                            <label
                              htmlFor="image-upload-edit"
                              className={`px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer text-sm ${uploading ? 'opacity-50' : ''}`}
                            >
                              {uploading ? '上传中...' : '更换图片'}
                            </label>
                            {formData.image_url && (
                              <img
                                src={formData.image_url}
                                alt="商品图片"
                                className="w-16 h-16 object-cover rounded-lg"
                              />
                            )}
                          </div>
                          {formData.image_url && (
                            <button
                              onClick={() => handleChange('image_url', '')}
                              className="text-red-600 text-xs mt-1 hover:underline"
                            >
                              删除图片
                            </button>
                          )}
                        </div>

                        <div className="flex items-center gap-6">
                          <label className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={formData.is_unlimited || false}
                              onChange={e => handleChange('is_unlimited', e.target.checked)}
                              className="rounded"
                            />
                            <span className="text-sm">预购商品（无限库存）</span>
                          </label>
                          <label className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={formData.is_published || false}
                              onChange={e => handleChange('is_published', e.target.checked)}
                              className="rounded"
                            />
                            <span className="text-sm">已上架</span>
                          </label>
                        </div>

                        {!formData.is_unlimited && (
                          <div className="grid md:grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1">当前库存</label>
                              <input
                                type="number"
                                value={formData.stock_quantity || 0}
                                onChange={e => handleChange('stock_quantity', e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1">最低库存提醒</label>
                              <input
                                type="number"
                                value={formData.min_stock_threshold || 5}
                                onChange={e => handleChange('min_stock_threshold', e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        )}

                        <div>
                          <label className="block text-sm font-medium mb-1">状态</label>
                          <select
                            value={formData.status || 'active'}
                            onChange={e => handleChange('status', e.target.value)}
                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="active">正常</option>
                            <option value="inactive">暂停</option>
                          </select>
                        </div>
                      </div>

                      <div className="flex justify-end gap-2 p-4 border-t">
                        <button
                          onClick={onCancel}
                          className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                        >
                          取消
                        </button>
                        <button
                          onClick={handleSubmit}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                          保存
                        </button>
                      </div>
                    </div>
                  </div>
                );
              };

              // 添加产品模态框组件
              const ProductAddModal = ({ onSave, onCancel, showToast }) => {
                const [formData, setFormData] = useState({
                  name: '',
                  emoji: '🍽️',
                  price: '',
                  category: '',
                  is_unlimited: false,
                  is_published: false,
                  stock_quantity: 0,
                  min_stock_threshold: 5,
                  status: 'active',
                  image_url: ''
                });
                const [uploading, setUploading] = useState(false);

                const handleChange = (field, value) => {
                  setFormData(prev => ({ ...prev, [field]: value }));
                };

                const handleImageUpload = async (file) => {
                  if (!file) return;
                  
                  setUploading(true);
                  try {
                    const ext = file.name.split('.').pop();
                    const filename = `products/${Date.now()}-${Math.random().toString(36).substring(7)}.${ext}`;
                    
                    const { error: uploadError } = await supabaseClient.storage
                      .from('product-photos')
                      .upload(filename, file);
                    
                    if (uploadError) {
                      showToast('图片上传失败: ' + uploadError.message, 'danger');
                      return;
                    }
                    
                    const { data: { publicUrl } } = supabaseClient.storage
                      .from('product-photos')
                      .getPublicUrl(filename);
                    
                    handleChange('image_url', publicUrl);
                    showToast('图片上传成功', 'success');
                  } catch (error) {
                    showToast('上传异常: ' + error.message, 'danger');
                  }
                  setUploading(false);
                };

                const handleSubmit = () => {
                  if (!formData.name || !formData.price) {
                    showToast('请填写商品名称和价格', 'danger');
                    return;
                  }
                  onSave(formData);
                };

                return (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                      <div className="flex justify-between items-center p-4 border-b">
                        <h3 className="text-lg font-bold">添加新产品</h3>
                        <button onClick={onCancel} className="text-gray-500 hover:text-gray-700">
                          <i className="fas fa-times"></i>
                        </button>
                      </div>
                      
                      <div className="p-6 space-y-4">
                        <div className="grid md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">商品名称 *</label>
                            <input
                              type="text"
                              value={formData.name}
                              onChange={e => handleChange('name', e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="请输入商品名称"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">表情符号</label>
                            <input
                              type="text"
                              value={formData.emoji}
                              onChange={e => handleChange('emoji', e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="🍽️"
                            />
                          </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">价格 (RM) *</label>
                            <input
                              type="number"
                              step="0.01"
                              value={formData.price}
                              onChange={e => handleChange('price', e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="0.00"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">分类</label>
                            <input
                              type="text"
                              value={formData.category}
                              onChange={e => handleChange('category', e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="例如：烤肠系列"
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-1">商品图片</label>
                          <div className="flex items-center gap-4">
                            <input
                              type="file"
                              accept="image/*"
                              onChange={e => e.target.files[0] && handleImageUpload(e.target.files[0])}
                              className="hidden"
                              id="image-upload-add"
                              disabled={uploading}
                            />
                            <label
                              htmlFor="image-upload-add"
                              className={`px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 cursor-pointer text-sm ${uploading ? 'opacity-50' : ''}`}
                            >
                              {uploading ? '上传中...' : '选择图片'}
                            </label>
                            {formData.image_url && (
                              <img
                                src={formData.image_url}
                                alt="预览"
                                className="w-16 h-16 object-cover rounded-lg"
                              />
                            )}
                          </div>
                          {formData.image_url && (
                            <button
                              onClick={() => handleChange('image_url', '')}
                              className="text-red-600 text-xs mt-1 hover:underline"
                            >
                              删除图片
                            </button>
                          )}
                        </div>

                        <div className="flex items-center gap-6">
                          <label className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={formData.is_unlimited}
                              onChange={e => handleChange('is_unlimited', e.target.checked)}
                              className="rounded"
                            />
                            <span className="text-sm">预购商品（无限库存）</span>
                          </label>
                          <label className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={formData.is_published}
                              onChange={e => handleChange('is_published', e.target.checked)}
                              className="rounded"
                            />
                            <span className="text-sm">立即上架</span>
                          </label>
                        </div>

                        {!formData.is_unlimited && (
                          <div className="grid md:grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1">初始库存</label>
                              <input
                                type="number"
                                value={formData.stock_quantity}
                                onChange={e => handleChange('stock_quantity', e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1">最低库存提醒</label>
                              <input
                                type="number"
                                value={formData.min_stock_threshold}
                                onChange={e => handleChange('min_stock_threshold', e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        )}

                        <div>
                          <label className="block text-sm font-medium mb-1">状态</label>
                          <select
                            value={formData.status}
                            onChange={e => handleChange('status', e.target.value)}
                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="active">正常</option>
                            <option value="inactive">暂停</option>
                          </select>
                        </div>
                      </div>

                      <div className="flex justify-end gap-2 p-4 border-t">
                        <button
                          onClick={onCancel}
                          className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                        >
                          取消
                        </button>
                        <button
                          onClick={handleSubmit}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                          disabled={uploading}
                        >
                          添加产品
                        </button>
                      </div>
                    </div>
                  </div>
                );
              };

              // ========= 库存管理 =========
              function Inventory() {
                const [products, setProducts] = useState([]);
                const [records, setRecords] = useState([]);
                const [loading, setLoading] = useState(true);

                useEffect(() => {
                  const fetchData = async () => {
                    setLoading(true);
                    try {
                      const [{ data: ps }, { data: rs }] = await Promise.all([
                        supabaseClient.from('products').select('*'),
                        supabaseClient.from('inventory_records').select('*').order('created_at', { ascending: false })
                      ]);
                      setProducts(ps || []);
                      setRecords(rs || []);
                    } catch (error) {
                      console.error('加载数据失败:', error);
                    }
                    setLoading(false);
                  };
                  fetchData();
                }, []);

                const total = products.filter(p => !p.is_unlimited).reduce((s, p) => s + ((p.stock_quantity ?? 0)), 0);
                const value = products.filter(p => !p.is_unlimited).reduce((s, p) => s + (((p.stock_quantity ?? 0) * (p.price || 0))), 0);
                const low = products.filter(p => {
                  const stock = p.stock_quantity ?? 0;
                  const threshold = p.min_stock_threshold ?? 5;
                  return !p.is_unlimited && stock <= threshold && stock > 0;
                }).length;
                const outOfStock = products.filter(p => !p.is_unlimited && (p.stock_quantity ?? 0) === 0).length;

                if (loading) {
                  return <LoadingSpinner text="加载库存数据..." />;
                }

                return (
                  <div className="space-y-6">
                    <div className="grid md:grid-cols-4 gap-4">
                      <div className="bg-white p-5 rounded shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-xs text-gray-500">总库存</p>
                            <p className="text-xl font-semibold mt-1">{total}</p>
                          </div>
                          <i className="fas fa-boxes text-blue-500 text-2xl"></i>
                        </div>
                      </div>
                      <div className="bg-white p-5 rounded shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-xs text-gray-500">库存价值</p>
                            <p className="text-xl font-semibold mt-1">RM{value.toFixed(2)}</p>
                          </div>
                          <i className="fas fa-dollar-sign text-green-500 text-2xl"></i>
                        </div>
                      </div>
                      <div className="bg-white p-5 rounded shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-xs text-gray-500">低库存商品</p>
                            <p className="text-xl font-semibold mt-1 text-orange-600">{low}</p>
                          </div>
                          <i className="fas fa-exclamation-triangle text-orange-500 text-2xl"></i>
                        </div>
                      </div>
                      <div className="bg-white p-5 rounded shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-xs text-gray-500">缺货商品</p>
                            <p className="text-xl font-semibold mt-1 text-red-600">{outOfStock}</p>
                          </div>
                          <i className="fas fa-times-circle text-red-500 text-2xl"></i>
                        </div>
                      </div>
                    </div>

                    <div className="bg-white p-5 rounded shadow">
                      <h3 className="font-semibold mb-4 text-lg">产品库存详情</h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="bg-gray-50">
                              <th className="p-3 text-left">商品</th>
                              <th className="p-3 text-left">类别</th>
                              <th className="p-3 text-left">价格</th>
                              <th className="p-3 text-left">库存状态</th>
                              <th className="p-3 text-left">当前库存</th>
                              <th className="p-3 text-left">最低库存</th>
                              <th className="p-3 text-left">状态</th>
                            </tr>
                          </thead>
                          <tbody>
                            {products.map(p => {
                              const stock = p.stock_quantity ?? 0;
                              const threshold = p.min_stock_threshold ?? 5;
                              const isLowStock = !p.is_unlimited && stock <= threshold && stock > 0;
                              const isOutOfStock = !p.is_unlimited && stock === 0;
                              
                              return (
                                <tr key={p.id} className="border-b hover:bg-gray-50">
                                  <td className="p-3">
                                    <div className="flex items-center gap-2">
                                      <span className="text-lg">{p.emoji || '🍽️'}</span>
                                      <span className="font-medium">{p.name}</span>
                                    </div>
                                  </td>
                                  <td className="p-3">{p.category || '-'}</td>
                                  <td className="p-3">RM{Number(p.price || 0).toFixed(2)}</td>
                                  <td className="p-3">
                                    {p.is_unlimited ? (
                                      <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                                        <i className="fas fa-infinity mr-1"></i>预购
                                      </span>
                                    ) : isOutOfStock ? (
                                      <span className="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">
                                        <i className="fas fa-times-circle mr-1"></i>缺货
                                      </span>
                                    ) : isLowStock ? (
                                      <span className="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs">
                                        <i className="fas fa-exclamation-triangle mr-1"></i>低库存
                                      </span>
                                    ) : (
                                      <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                                        <i className="fas fa-check-circle mr-1"></i>正常
                                      </span>
                                    )}
                                  </td>
                                  <td className="p-3">
                                    {p.is_unlimited ? '无限制' : stock}
                                  </td>
                                  <td className="p-3">
                                    {p.is_unlimited ? '-' : threshold}
                                  </td>
                                  <td className="p-3">
                                    <span className={`px-2 py-1 rounded-full text-xs ${
                                      p.is_published 
                                        ? 'bg-green-100 text-green-800' 
                                        : 'bg-gray-100 text-gray-800'
                                    }`}>
                                      {p.is_published ? '已上架' : '已下架'}
                                    </span>
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                        {products.length === 0 && (
                          <div className="text-center py-8 text-gray-500">
                            <i className="fas fa-box-open text-4xl mb-2"></i>
                            <p>暂无产品数据</p>
                          </div>
                        )}
                      </div>
                    </div>

                    {records.length > 0 && (
                      <div className="bg-white p-5 rounded shadow">
                        <h3 className="font-semibold mb-3">最近库存记录</h3>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="bg-gray-50">
                                <th className="p-2 text-left">产品</th>
                                <th className="p-2 text-left">类型</th>
                                <th className="p-2 text-left">数量</th>
                                <th className="p-2 text-left">日期</th>
                                <th className="p-2 text-left">操作人</th>
                              </tr>
                            </thead>
                            <tbody>
                              {records.slice(0, 10).map(r => (
                                <tr key={r.id} className="border-b">
                                  <td className="p-2">{r.product_name}</td>
                                  <td className="p-2">{r.type}</td>
                                  <td className="p-2">{r.quantity}</td>
                                  <td className="p-2">{r.date}</td>
                                  <td className="p-2">{r.operator}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>
                );
              }

              // ========= 订单 =========
              function Orders() {
                const [orders, setOrders] = useState([]);
                const [loading, setLoading] = useState(true);
                const [toast, setToast] = useState(null);
                const [updating, setUpdating] = useState(null);
                const [file, setFile] = useState(null);
                const [modalOrder, setModalOrder] = useState(null);
                const [filterStatus, setFilterStatus] = useState('');
                const [filterDelivery, setFilterDelivery] = useState('');
                const [searchText, setSearchText] = useState('');

                const fetchOrders = useCallback(async () => {
                  setLoading(true);
                  const { data, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                  if (error) {
                    setOrders([]);
                    setToast({ message: '加载失败:' + error.message, type: 'danger' });
                  } else {
                    setOrders(data || []);
                  }
                  setLoading(false);
                }, []);

                useEffect(() => {
                  fetchOrders();
                }, [fetchOrders]);

                const updateStatus = async (id, status) => {
                  setUpdating(id);
                  const { error } = await supabaseClient
                    .from('orders')
                    .update({ status })
                    .eq('id', id);
                    
                  if (error) {
                    setToast({ message: '状态失败:' + error.message, type: 'danger' });
                  } else {
                    setToast({ message: '状态已更新', type: 'success' });
                    fetchOrders();
                  }
                  setUpdating(null);
                };

                const copyDetails = async (o) => {
                  const ok = await copyTextUniversal(buildOrderMessage(o).replace(/\*/g, ''));
                  setToast({
                    message: ok ? '已复制' : '复制失败',
                    type: ok ? 'success' : 'danger'
                  });
                };

                const uploadProof = async () => {
                  if (!file || !modalOrder) return;
                  const ext = file.name.split('.').pop();
                  const path = `proofs/${modalOrder.order_id}-shipping.${ext}`;
                  
                  const { error } = await supabaseClient.storage
                    .from('payment-proofs')
                    .upload(path, file, { upsert: true });
                    
                  if (error) {
                    setToast({ message: '上传失败:' + error.message, type: 'danger' });
                    return;
                  }
                  
                  const { data: { publicUrl } } = supabaseClient.storage
                    .from('payment-proofs')
                    .getPublicUrl(path);
                    
                  await supabaseClient
                    .from('orders')
                    .update({ shipping_payment_proof_url: publicUrl })
                    .eq('order_id', modalOrder.order_id);
                    
                  setToast({ message: '已上传', type: 'success' });
                  setFile(null);
                  setModalOrder(null);
                  fetchOrders();
                };

                const getStatusDisplay = (status) => {
                  const statusMap = {
                    'pending': '待处理',
                    'ready for pick up': '待取货',
                    'delivered': '已发货',
                    'completed': '已完成',
                    'cancelled': '已取消'
                  };
                  return statusMap[status] || status;
                };

                const getStatusColor = (status) => {
                  const colorMap = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'ready for pick up': 'bg-blue-100 text-blue-800',
                    'delivered': 'bg-green-100 text-green-800',
                    'completed': 'bg-green-100 text-green-800',
                    'cancelled': 'bg-red-100 text-red-800'
                  };
                  return colorMap[status] || 'bg-gray-100 text-gray-800';
                };

                // 过滤订单
                const filteredOrders = orders.filter(order => {
                  const matchesStatus = !filterStatus || order.status === filterStatus;
                  const matchesDelivery = !filterDelivery || order.delivery_method === filterDelivery;
                  const matchesSearch = !searchText || 
                    order.order_id.toLowerCase().includes(searchText.toLowerCase()) ||
                    order.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    order.phone.toLowerCase().includes(searchText.toLowerCase());
                  return matchesStatus && matchesDelivery && matchesSearch;
                });

                return (
                  <div className="bg-white p-6 rounded-lg shadow relative">
                    <div className="flex flex-wrap gap-3 items-center justify-between mb-4">
                      <h2 className="text-lg font-bold">订单管理 ({filteredOrders.length}/{orders.length})</h2>
                      <div className="flex gap-2">
                        <input
                          type="text"
                          placeholder="搜索订单号、客户姓名或电话"
                          value={searchText}
                          onChange={(e) => setSearchText(e.target.value)}
                          className="border px-3 py-1.5 rounded text-sm"
                        />
                        <select
                          value={filterStatus}
                          onChange={(e) => setFilterStatus(e.target.value)}
                          className="border px-3 py-1.5 rounded text-sm"
                        >
                          <option value="">全部状态</option>
                          <option value="pending">待处理</option>
                          <option value="ready for pick up">待取货</option>
                          <option value="delivered">已发货</option>
                          <option value="completed">已完成</option>
                          <option value="cancelled">已取消</option>
                        </select>
                        <select
                          value={filterDelivery}
                          onChange={(e) => setFilterDelivery(e.target.value)}
                          className="border px-3 py-1.5 rounded text-sm"
                        >
                          <option value="">全部方式</option>
                          <option value="self-pickup">自取</option>
                          <option value="lalamove">Lalamove送货</option>
                        </select>
                        <button
                          onClick={fetchOrders}
                          className="px-3 py-1.5 text-sm rounded bg-gray-100 hover:bg-gray-200"
                        >
                          <i className="fas fa-sync-alt mr-1"></i>刷新
                        </button>
                      </div>
                    </div>

                    {loading ? (
                      <LoadingSpinner text="加载订单..." />
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="bg-gray-100">
                              <th className="p-3 text-left">订单号</th>
                              <th className="p-3 text-left">客户信息</th>
                              <th className="p-3 text-left">订单明细</th>
                              <th className="p-3 text-left">金额</th>
                              <th className="p-3 text-left">状态</th>
                              <th className="p-3 text-left">下单时间</th>
                              <th className="p-3 text-left">操作</th>
                            </tr>
                          </thead>
                          <tbody>
                            {filteredOrders.map(order => (
                              <tr key={order.id} className="border-b align-top hover:bg-gray-50">
                                <td className="p-3">
                                  <span className="font-medium text-blue-600">{order.order_id}</span>
                                  <div className="text-xs text-gray-500 mt-1">
                                    {order.delivery_method === 'self-pickup' ? '自提' : 'Lalamove配送'}
                                  </div>
                                </td>
                                <td className="p-3">
                                  <div className="font-medium">{order.name}</div>
                                  <div className="text-xs text-gray-500">{order.phone}</div>
                                  {order.address && (
                                    <div className="text-xs text-gray-500 mt-1">{order.address}</div>
                                  )}
                                </td>
                                <td className="p-3 text-xs">
                                  {(order.order_items || []).map((item, index) => (
                                    <div key={index} className="mb-1">
                                      <span className="mr-1">{item.emoji || '▫️'}</span>
                                      {item.product} × {item.quantity}
                                    </div>
                                  ))}
                                  {order.remarks && (
                                    <div className="text-gray-500 mt-2 italic">备注: {order.remarks}</div>
                                  )}
                                </td>
                                <td className="p-3">
                                  <span className="text-red-600 font-semibold">
                                    RM{Number(order.total_amount || 0).toFixed(2)}
                                  </span>
                                </td>
                                <td className="p-3">
                                  {updating === order.id ? (
                                    <span className="text-xs">更新中...</span>
                                  ) : (
                                    <select
                                      className="text-xs border rounded px-2 py-1 bg-white"
                                      value={order.status}
                                      onChange={(e) => updateStatus(order.id, e.target.value)}
                                    >
                                      <option value="pending">待处理</option>
                                      <option value="ready for pick up">待取货</option>
                                      <option value="delivered">已发货</option>
                                      <option value="completed">已完成</option>
                                      <option value="cancelled">已取消</option>
                                    </select>
                                  )}
                                  <div className="mt-1">
                                    <span className={`inline-block px-2 py-1 rounded-full text-xs ${getStatusColor(order.status)}`}>
                                      {getStatusDisplay(order.status)}
                                    </span>
                                  </div>
                                </td>
                                <td className="p-3 text-xs text-gray-500">
                                  {new Date(order.created_at).toLocaleString('zh-CN')}
                                </td>
                                <td className="p-3">
                                  <div className="space-y-1 flex flex-col min-w-[110px]">
                                    {order.payment_proof_url && (
                                      <a
                                        href={order.payment_proof_url}
                                        target="_blank"
                                        className="text-blue-600 text-xs underline hover:text-blue-800"
                                      >
                                        支付凭证
                                      </a>
                                    )}
                                    <button
                                      onClick={() => copyDetails(order)}
                                      className="bg-teal-500 hover:bg-teal-600 text-white text-xs rounded px-2 py-1"
                                    >
                                      复制详情
                                    </button>
                                    <button
                                      onClick={() => setModalOrder(order)}
                                      className="bg-purple-500 hover:bg-purple-600 text-white text-xs rounded px-2 py-1"
                                    >
                                      上传运费凭证
                                    </button>
                                    <button
                                      onClick={() => printOrder(order)}
                                      className="bg-indigo-500 hover:bg-indigo-600 text-white text-xs rounded px-2 py-1"
                                    >
                                      打印订单
                                    </button>
                                    {order.shipping_payment_proof_url && (
                                      <a
                                        href={order.shipping_payment_proof_url}
                                        target="_blank"
                                        className="text-purple-600 text-xs underline hover:text-purple-800"
                                      >
                                        运费凭证
                                      </a>
                                    )}
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                        {filteredOrders.length === 0 && (
                          <div className="text-center py-8 text-gray-500">
                            <i className="fas fa-inbox text-4xl mb-2"></i>
                            <p>没有找到符合条件的订单</p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Toast 通知 */}
                    {toast && (
                      <div className="fixed top-4 right-4 z-50">
                        <Toast {...toast} onDismiss={() => setToast(null)} />
                      </div>
                    )}

                    {/* 上传运费凭证模态框 */}
                    {modalOrder && (
                      <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-40 p-4">
                        <div className="bg-white rounded shadow w-full max-w-md">
                          <div className="flex justify-between items-center border-b px-4 py-3">
                            <h3 className="font-semibold">上传运费凭证 - {modalOrder.order_id}</h3>
                            <button
                              onClick={() => { setModalOrder(null); setFile(null); }}
                              className="text-gray-500 hover:text-gray-700"
                            >
                              <i className="fas fa-times"></i>
                            </button>
                          </div>
                          <div className="p-4 space-y-3">
                            <input
                              type="file"
                              accept="image/*,.pdf"
                              onChange={(e) => setFile(e.target.files[0])}
                              className="w-full"
                            />
                            <button
                              disabled={!file}
                              onClick={uploadProof}
                              className="w-full px-3 py-2 rounded bg-purple-600 text-white disabled:bg-gray-300"
                            >
                              {file ? '上传凭证' : '请选择文件'}
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                );
              }

              // ========= 扫码 =========
              function Scanner(){ const [mode,setMode]=useState('camera'); const [active,setActive]=useState(false); const [results,setResults]=useState([]); const ref=useRef(null); const ID='html5-qrcode-box'; useEffect(()=>{ if(mode==='camera'&&active){ if(!window.Html5Qrcode) return; if(!ref.current){ ref.current=new Html5Qrcode(ID); ref.current.start({facingMode:'environment'},{fps:10,qrbox:250},(code)=>{ setResults(r=>[{code,ts:Date.now()},...r.slice(0,49)]); },()=>{}); } } return()=>{}; },[mode,active]); const stop=()=>{ if(ref.current){ ref.current.stop().catch(()=>{}); ref.current.clear(); ref.current=null;} setActive(false); }; useEffect(()=>()=>stop(),[]); useEffect(()=>{ if(mode!=='gun') return; let buf=''; let last=0; const h=e=>{ const now=Date.now(); if(now-last>100) buf=''; last=now; if(e.key==='Enter'){ if(buf.trim()) setResults(r=>[{code:buf.trim(),ts:Date.now()},...r.slice(0,49)]); buf=''; } else if(e.key.length===1) buf+=e.key; }; window.addEventListener('keydown',h); return()=>window.removeEventListener('keydown',h); },[mode]); return <div className="bg-white p-6 rounded-lg shadow"><h2 className="text-lg font-bold mb-4">扫码功能</h2><div className="flex gap-3 mb-4"><button className={`px-3 py-1.5 rounded ${mode==='camera'?'bg-red-600 text-white':'bg-gray-200'}`} onClick={()=>{setMode('camera');}}>摄像头</button><button className={`px-3 py-1.5 rounded ${mode==='gun'?'bg-red-600 text-white':'bg-gray-200'}`} onClick={()=>{setMode('gun'); stop();}}>扫码枪</button></div>{mode==='camera' && <div className="space-y-3"><div id={ID} style={{width:'300px'}}></div><div>{active? <button onClick={stop} className="px-3 py-1.5 bg-gray-200 rounded">停止</button>:<button onClick={()=>setActive(true)} className="px-3 py-1.5 bg-green-600 text-white rounded">启动</button>}</div></div>}{mode==='gun' && <p className="text-xs text-gray-500 mb-2">焦点在页面即可直接扫，或输入后回车。</p>}<h3 className="font-semibold mt-6 mb-2">最近结果</h3><ul className="text-xs max-h-56 overflow-auto space-y-1 border p-2 rounded bg-gray-50">{results.length===0&&<li className="text-gray-400">暂无</li>}{results.map(r=> <li key={r.ts}>{new Date(r.ts).toLocaleTimeString()} - {r.code}</li>)}</ul></div>; }

              // ========= 拍照 =========
              function Camera(){ const videoRef=useRef(null); const canvasRef=useRef(null); const [streaming,setStreaming]=useState(false); const [photo,setPhoto]=useState(null); const [uploading,setUploading]=useState(false); const start=async()=>{ try{ const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); videoRef.current.srcObject=s; setStreaming(true);}catch(e){ alert('无法访问摄像头:'+e.message);} }; const stop=()=>{ if(videoRef.current?.srcObject){ videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); } setStreaming(false); }; useEffect(()=>()=>stop(),[]); const snap=()=>{ const v=videoRef.current; const c=canvasRef.current; if(!v||!c) return; c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0); const data=c.toDataURL('image/jpeg',0.9); setPhoto(data); }; const upload=async()=>{ if(!photo) return; setUploading(true); try{ const blob=await (await fetch(photo)).blob(); const filename='admin-captures/'+Date.now()+'.jpg'; const {error}=await supabaseClient.storage.from('product-photos').upload(filename,blob); if(error) alert('上传失败:'+error.message); else alert('上传成功:'+filename);}catch(e){ alert('异常:'+e.message);} setUploading(false); }; return <div className="bg-white p-6 rounded-lg shadow"><h2 className="text-lg font-bold mb-4">拍照功能</h2><div className="flex flex-col md:flex-row gap-6"><div><video ref={videoRef} autoPlay playsInline className="w-72 rounded-lg bg-black"/><div className="mt-3 space-x-2"><button onClick={streaming?stop:start} className="px-3 py-1.5 rounded bg-gray-200">{streaming?'停止':'启动'}</button><button onClick={snap} disabled={!streaming} className="px-3 py-1.5 rounded bg-red-600 text-white disabled:bg-gray-300">拍照</button></div></div><div className="flex flex-col items-start gap-3"><canvas ref={canvasRef} className="hidden"/><div className="w-60 h-44 flex items-center justify-center bg-gray-100 rounded overflow-hidden">{photo? <img src={photo} alt="preview" className="w-full"/>:<span className="text-gray-400 text-sm">暂无照片</span>}</div><div className="space-x-2"><a download={'capture-'+Date.now()+'.jpg'} href={photo||'#'} className={'px-3 py-1.5 text-sm rounded bg-indigo-600 text-white '+(photo?'':'pointer-events-none opacity-40')}>下载</a><button onClick={upload} disabled={!photo||uploading} className="px-3 py-1.5 text-sm rounded bg-green-600 text-white disabled:bg-gray-300">{uploading?'上传中...':'上传到Supabase'}</button></div></div></div></div>; }

              // ========= 数据分析 =========
              function Analytics() {
                const [orders, setOrders] = useState([]);
                const [products, setProducts] = useState([]);
                const [activeTab, setActiveTab] = useState('overview');
                const [loading, setLoading] = useState(true);
                const lineRef = useRef(null);
                const doughRef = useRef(null);
                const productBarRef = useRef(null);
                const productPieRef = useRef(null);
                const productOrderRef = useRef(null);
                const lineChart = useRef(null);
                const doughChart = useRef(null);
                const productBarChart = useRef(null);
                const productPieChart = useRef(null);
                const productOrderChart = useRef(null);

                // 产品映射表 - 将相似产品名称合并
                const productMapping = {
                  '鲜肉小笼汤包 ( 1 袋 9只）': '鲜肉小笼汤包',
                  '黑松露小笼汤包 ( 1 袋 6只）': '黑松露小笼汤包',
                  '黑猪三丁纸皮烧卖 ( 1 袋 6只）': '黑猪三丁纸皮烧卖',
                  '黑猪肉酥饼 (一份 3袋，每 袋 4片）': '黑猪肉酥饼',
                  '菌菇小笼汤包 ( 1 袋 9只）': '菌菇小笼汤包',
                  '安格斯牛肉酥饼 (一份 3袋，每 袋 4片）': '安格斯牛肉酥饼',
                  '黑椒牛肉纸皮烧卖 ( 1 袋 6只）': '黑椒牛肉纸皮烧卖',
                  '乌米腊味纸皮烧卖 ( 1 袋 6只）': '乌米腊味纸皮烧卖',
                  '黑猪梅菜干纸皮烧卖 ( 1 袋 6只）': '黑猪梅菜干纸皮烧卖',
                  '三丁芝士纸皮烧卖 ( 1 袋 6只）': '三丁芝士纸皮烧卖'
                };

                // 获取合并后的产品名称
                const getConsolidatedProductName = (originalName) => {
                  return productMapping[originalName] || originalName;
                };

                useEffect(() => {
                  const fetchData = async () => {
                    setLoading(true);
                    try {
                      // 获取所有历史数据，不再限制时间范围
                      const [ordersResult, productsResult] = await Promise.all([
                        supabaseClient.from('orders').select('*').order('created_at', { ascending: false }),
                        supabaseClient.from('products').select('*')
                      ]);
                      
                      setOrders(ordersResult.data || []);
                      setProducts(productsResult.data || []);
                    } catch (error) {
                      console.error('数据加载失败:', error);
                    }
                    setLoading(false);
                  };
                  fetchData();
                }, []);

                // 绘制销售概览图表
                useEffect(() => {
                  if (!orders.length || !window.Chart || activeTab !== 'overview') return;
                  
                  // 销售趋势图 - 显示最近90天的数据
                  const dayMap = {};
                  for (let i = 0; i < 90; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    dayMap[d.toISOString().slice(0, 10)] = 0;
                  }
                  
                  orders.forEach(o => {
                    const k = o.created_at?.slice(0, 10);
                    if (dayMap[k] != null) dayMap[k] += Number(o.total_amount) || 0;
                  });
                  
                  const labels = Object.keys(dayMap).sort();
                  const values = labels.map(k => dayMap[k]);
                  
                  if (lineChart.current) lineChart.current.destroy();
                  if (lineRef.current) {
                    lineChart.current = new Chart(lineRef.current, {
                      type: 'line',
                      data: {
                        labels,
                        datasets: [{
                          label: '每日销售额 (RM)',
                          data: values,
                          borderColor: '#dc2626',
                          backgroundColor: 'rgba(220,38,38,.15)',
                          fill: true,
                          tension: .25
                        }]
                      }
                    });
                  }
                  
                  // 预购vs现货占比图
                  const catMap = {};
                  orders.forEach(o =>
                    (o.order_items || []).forEach(it => {
                      const c = it.is_unlimited ? '预购' : '现货';
                      catMap[c] = (catMap[c] || 0) + (it.quantity * it.price);
                    })
                  );
                  
                  if (doughChart.current) doughChart.current.destroy();
                  if (doughRef.current) {
                    doughChart.current = new Chart(doughRef.current, {
                      type: 'doughnut',
                      data: {
                        labels: Object.keys(catMap),
                        datasets: [{
                          data: Object.values(catMap),
                          backgroundColor: ['#f87171', '#60a5fa']
                        }]
                      },
                      options: {
                        plugins: {
                          legend: { position: 'bottom' }
                        }
                      }
                    });
                  }
                }, [orders, activeTab]);

                // 绘制产品分析图表
                useEffect(() => {
                  if (!orders.length || !window.Chart || activeTab !== 'products') return;
                  
                  const topProducts = getTopProducts();
                  
                  // 畅销商品销量条形图
                  if (productBarChart.current) productBarChart.current.destroy();
                  if (productBarRef.current && topProducts.length > 0) {
                    productBarChart.current = new Chart(productBarRef.current, {
                      type: 'bar',
                      data: {
                        labels: topProducts.slice(0, 8).map(p => p.name.length > 10 ? p.name.substring(0, 10) + '...' : p.name),
                        datasets: [{
                          label: '销售数量',
                          data: topProducts.slice(0, 8).map(p => p.quantity),
                          backgroundColor: [
                            '#fbbf24', '#f59e0b', '#d97706', '#92400e',
                            '#3b82f6', '#2563eb', '#1d4ed8', '#1e40af'
                          ],
                          borderColor: [
                            '#f59e0b', '#d97706', '#b45309', '#78350f',
                            '#2563eb', '#1d4ed8', '#1e3a8a', '#1e3a8a'
                          ],
                          borderWidth: 1
                        }]
                      },
                      options: {
                        responsive: true,
                        plugins: {
                          legend: { display: false }
                        },
                        scales: {
                          y: {
                            beginAtZero: true,
                            title: { display: true, text: '销售数量' }
                          }
                        }
                      }
                    });
                  }
                  
                  // 产品销售额饼图
                  if (productPieChart.current) productPieChart.current.destroy();
                  if (productPieRef.current && topProducts.length > 0) {
                    productPieChart.current = new Chart(productPieRef.current, {
                      type: 'pie',
                      data: {
                        labels: topProducts.slice(0, 6).map(p => p.name),
                        datasets: [{
                          data: topProducts.slice(0, 6).map(p => p.revenue),
                          backgroundColor: [
                            '#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6'
                          ],
                          borderColor: '#ffffff',
                          borderWidth: 2
                        }]
                      },
                      options: {
                        responsive: true,
                        plugins: {
                          legend: { position: 'bottom' }
                        }
                      }
                    });
                  }
                  
                  // 产品订单频次图
                  const productOrderStats = {};
                  orders.forEach(order => {
                    (order.order_items || []).forEach(item => {
                      // 排除运费专用项目
                      if (item.product === '运费专用' || item.product.includes('运费')) return;
                      
                      // 使用合并后的产品名称
                      const consolidatedName = getConsolidatedProductName(item.product);
                      productOrderStats[consolidatedName] = (productOrderStats[consolidatedName] || 0) + 1;
                    });
                  });
                  
                  const sortedOrderStats = Object.entries(productOrderStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 8);
                  
                  if (productOrderChart.current) productOrderChart.current.destroy();
                  if (productOrderRef.current && sortedOrderStats.length > 0) {
                    productOrderChart.current = new Chart(productOrderRef.current, {
                      type: 'doughnut',
                      data: {
                        labels: sortedOrderStats.map(([name]) => name.length > 12 ? name.substring(0, 12) + '...' : name),
                        datasets: [{
                          data: sortedOrderStats.map(([, count]) => count),
                          backgroundColor: [
                            '#10b981', '#06b6d4', '#8b5cf6', '#f59e0b',
                            '#ef4444', '#84cc16', '#f97316', '#6366f1'
                          ],
                          borderColor: '#ffffff',
                          borderWidth: 2
                        }]
                      },
                      options: {
                        responsive: true,
                        plugins: {
                          legend: { position: 'bottom' }
                        }
                      }
                    });
                  }
                }, [orders, activeTab]);

                // 计算畅销商品TOP 10
                const getTopProducts = () => {
                  const productSales = {};
                  orders.forEach(order => {
                    (order.order_items || []).forEach(item => {
                      // 排除运费专用项目
                      if (item.product === '运费专用' || item.product.includes('运费')) return;
                      
                      // 使用合并后的产品名称
                      const consolidatedName = getConsolidatedProductName(item.product);
                      
                      if (productSales[consolidatedName]) {
                        productSales[consolidatedName].quantity += item.quantity;
                        productSales[consolidatedName].revenue += item.quantity * item.price;
                        productSales[consolidatedName].variants = productSales[consolidatedName].variants || new Set();
                        productSales[consolidatedName].variants.add(item.product);
                      } else {
                        productSales[consolidatedName] = {
                          name: consolidatedName,
                          quantity: item.quantity,
                          revenue: item.quantity * item.price,
                          variants: new Set([item.product])
                        };
                      }
                    });
                  });
                  
                  return Object.values(productSales)
                    .map(product => ({
                      ...product,
                      variantCount: product.variants.size,
                      variants: Array.from(product.variants)
                    }))
                    .sort((a, b) => b.quantity - a.quantity)
                    .slice(0, 10);
                };

                // 计算所有产品销量
                const getAllProductSales = () => {
                  const productSales = {};
                  orders.forEach(order => {
                    (order.order_items || []).forEach(item => {
                      // 排除运费专用项目
                      if (item.product === '运费专用' || item.product.includes('运费')) return;
                      
                      // 使用合并后的产品名称
                      const consolidatedName = getConsolidatedProductName(item.product);
                      
                      if (productSales[consolidatedName]) {
                        productSales[consolidatedName].quantity += item.quantity;
                        productSales[consolidatedName].revenue += item.quantity * item.price;
                        productSales[consolidatedName].orders += 1;
                        productSales[consolidatedName].variants = productSales[consolidatedName].variants || new Set();
                        productSales[consolidatedName].variants.add(item.product);
                      } else {
                        productSales[consolidatedName] = {
                          name: consolidatedName,
                          quantity: item.quantity,
                          revenue: item.quantity * item.price,
                          orders: 1,
                          variants: new Set([item.product])
                        };
                      }
                    });
                  });
                  
                  return Object.values(productSales)
                    .map(product => ({
                      ...product,
                      variantCount: product.variants.size,
                      variants: Array.from(product.variants)
                    }))
                    .sort((a, b) => b.quantity - a.quantity);
                };

                // 获取低库存产品
                const getLowStockProducts = () => {
                  return products.filter(p => {
                    if (p.is_unlimited) return false;
                    const stock = p.stock_quantity ?? 0;
                    const threshold = p.min_stock_threshold ?? 5;
                    return stock <= threshold;
                  }).sort((a, b) => (a.stock_quantity ?? 0) - (b.stock_quantity ?? 0));
                };

                // 计算TOP 10客户
                const getTopCustomers = () => {
                  const customerSales = {};
                  orders.forEach(order => {
                    const key = `${order.name} (${order.phone})`;
                    if (customerSales[key]) {
                      customerSales[key].totalAmount += Number(order.total_amount) || 0;
                      customerSales[key].orderCount += 1;
                    } else {
                      customerSales[key] = {
                        name: order.name,
                        phone: order.phone,
                        totalAmount: Number(order.total_amount) || 0,
                        orderCount: 1
                      };
                    }
                  });
                  
                  return Object.values(customerSales)
                    .sort((a, b) => b.totalAmount - a.totalAmount)
                    .slice(0, 10);
                };

                if (loading) {
                  return <LoadingSpinner text="加载数据分析..." />;
                }

                const topProducts = getTopProducts();
                const allProductSales = getAllProductSales();
                const lowStockProducts = getLowStockProducts();
                const topCustomers = getTopCustomers();

                return (
                  <div className="bg-white p-6 rounded-lg shadow space-y-6">
                    <h2 className="text-lg font-bold">数据分析</h2>
                    
                    {/* 选项卡导航 */}
                    <div className="border-b">
                      <nav className="-mb-px flex space-x-8">
                        {[
                          { id: 'overview', name: '销售概览', icon: 'chart-line' },
                          { id: 'products', name: '产品分析', icon: 'box' },
                          { id: 'inventory', name: '库存分析', icon: 'warehouse' },
                          { id: 'customers', name: '客户分析', icon: 'users' }
                        ].map((tab) => (
                          <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
                              activeTab === tab.id
                                ? 'border-red-500 text-red-600'
                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                            }`}
                          >
                            <i className={`fas fa-${tab.icon}`}></i>
                            {tab.name}
                          </button>
                        ))}
                      </nav>
                    </div>

                    {/* 销售概览 */}
                    {activeTab === 'overview' && (
                      <div className="grid md:grid-cols-2 gap-8">
                        <div>
                          <h3 className="font-semibold mb-2">最近90天销售趋势</h3>
                          <canvas ref={lineRef} height="210"></canvas>
                        </div>
                        <div>
                          <h3 className="font-semibold mb-2">预购 vs 现货 金额占比（全部数据）</h3>
                          <canvas ref={doughRef} height="210"></canvas>
                        </div>
                      </div>
                    )}

                    {/* 产品分析 */}
                    {activeTab === 'products' && (
                      <div className="space-y-8">
                        {/* 产品分析图表 */}
                        <div className="grid md:grid-cols-3 gap-6">
                          <div className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-semibold mb-3 text-center">畅销商品销量排行</h4>
                            <canvas ref={productBarRef} height="200"></canvas>
                          </div>
                          <div className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-semibold mb-3 text-center">销售额占比分布</h4>
                            <canvas ref={productPieRef} height="200"></canvas>
                          </div>
                          <div className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-semibold mb-3 text-center">订单频次分布</h4>
                            <canvas ref={productOrderRef} height="200"></canvas>
                          </div>
                        </div>

                        {/* 畅销商品TOP 10 */}
                        <div>
                          <h3 className="font-semibold mb-4 text-lg flex items-center gap-2">
                            <i className="fas fa-trophy text-yellow-500"></i>
                            畅销商品 TOP 10
                          </h3>
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                              <thead>
                                <tr className="bg-gray-50">
                                  <th className="p-3 text-left">排名</th>
                                  <th className="p-3 text-left">商品名称</th>
                                  <th className="p-3 text-left">销售数量</th>
                                  <th className="p-3 text-left">销售金额</th>
                                  <th className="p-3 text-left">变体数量</th>
                                </tr>
                              </thead>
                              <tbody>
                                {topProducts.map((product, index) => (
                                  <tr key={product.name} className="border-b hover:bg-gray-50">
                                    <td className="p-3">
                                      <span className={`px-2 py-1 rounded text-xs font-medium ${
                                        index === 0 ? 'bg-yellow-100 text-yellow-800' :
                                        index === 1 ? 'bg-gray-100 text-gray-800' :
                                        index === 2 ? 'bg-orange-100 text-orange-800' :
                                        'bg-blue-100 text-blue-800'
                                      }`}>
                                        #{index + 1}
                                      </span>
                                    </td>
                                    <td className="p-3">
                                      <div className="font-medium">{product.name}</div>
                                      {product.variantCount > 1 && (
                                        <div className="text-xs text-gray-500 mt-1">
                                          包含 {product.variantCount} 个变体
                                        </div>
                                      )}
                                    </td>
                                    <td className="p-3">{product.quantity}</td>
                                    <td className="p-3 font-medium text-green-600">RM{product.revenue.toFixed(2)}</td>
                                    <td className="p-3">
                                      <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                        {product.variantCount}
                                      </span>
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                            {topProducts.length === 0 && (
                              <div className="text-center py-8 text-gray-500">
                                <i className="fas fa-chart-bar text-4xl mb-2"></i>
                                <p>暂无销售数据</p>
                              </div>
                            )}
                          </div>
                        </div>

                        {/* 所有产品销量统计 */}
                        <div>
                          <h3 className="font-semibold mb-4 text-lg flex items-center gap-2">
                            <i className="fas fa-chart-bar text-blue-500"></i>
                            所有产品销量统计
                          </h3>
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                              <thead>
                                <tr className="bg-gray-50">
                                  <th className="p-3 text-left">商品名称</th>
                                  <th className="p-3 text-left">销售数量</th>
                                  <th className="p-3 text-left">订单次数</th>
                                  <th className="p-3 text-left">总金额</th>
                                  <th className="p-3 text-left">平均单价</th>
                                  <th className="p-3 text-left">变体数量</th>
                                </tr>
                              </thead>
                              <tbody>
                                {allProductSales.map((product) => (
                                  <tr key={product.name} className="border-b hover:bg-gray-50">
                                    <td className="p-3">
                                      <div className="font-medium">{product.name}</div>
                                      {product.variantCount > 1 && (
                                        <div className="text-xs text-gray-500 mt-1">
                                          变体: {product.variants.slice(0, 2).join(', ')}
                                          {product.variants.length > 2 && `...等${product.variants.length}种`}
                                        </div>
                                      )}
                                    </td>
                                    <td className="p-3">{product.quantity}</td>
                                    <td className="p-3">{product.orders}</td>
                                    <td className="p-3 text-green-600">RM{product.revenue.toFixed(2)}</td>
                                    <td className="p-3">RM{(product.revenue / product.quantity).toFixed(2)}</td>
                                    <td className="p-3">
                                      <span className={`px-2 py-1 rounded text-xs ${
                                        product.variantCount > 1 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'
                                      }`}>
                                        {product.variantCount}
                                      </span>
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                            {allProductSales.length === 0 && (
                              <div className="text-center py-8 text-gray-500">
                                <i className="fas fa-chart-bar text-4xl mb-2"></i>
                                <p>暂无销售数据</p>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* 库存分析 */}
                    {activeTab === 'inventory' && (
                      <div>
                        <h3 className="font-semibold mb-4 text-lg flex items-center gap-2">
                          <i className="fas fa-exclamation-triangle text-red-500"></i>
                          低库存产品监控
                        </h3>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="bg-gray-50">
                                <th className="p-3 text-left">商品名称</th>
                                <th className="p-3 text-left">当前库存</th>
                                <th className="p-3 text-left">最低库存</th>
                                <th className="p-3 text-left">状态</th>
                                <th className="p-3 text-left">建议</th>
                              </tr>
                            </thead>
                            <tbody>
                              {lowStockProducts.map((product) => {
                                const stock = product.stock_quantity ?? 0;
                                const threshold = product.min_stock_threshold ?? 5;
                                const isOutOfStock = stock === 0;
                                const isLowStock = stock <= threshold && stock > 0;
                                
                                return (
                                  <tr key={product.id} className="border-b hover:bg-gray-50">
                                    <td className="p-3 font-medium">{product.name}</td>
                                    <td className="p-3">
                                      <span className={`font-medium ${
                                        isOutOfStock ? 'text-red-600' : isLowStock ? 'text-orange-600' : 'text-green-600'
                                      }`}>
                                        {stock}
                                      </span>
                                    </td>
                                    <td className="p-3">{threshold}</td>
                                    <td className="p-3">
                                      <span className={`px-2 py-1 rounded-full text-xs ${
                                        isOutOfStock ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'
                                      }`}>
                                        {isOutOfStock ? '缺货' : '低库存'}
                                      </span>
                                    </td>
                                    <td className="p-3 text-sm text-gray-600">
                                      {isOutOfStock ? '立即补货' : '需要补货'}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                          {lowStockProducts.length === 0 && (
                            <div className="text-center py-8 text-gray-500">
                              <i className="fas fa-check-circle text-4xl mb-2 text-green-500"></i>
                              <p>所有产品库存充足</p>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* 客户分析 */}
                    {activeTab === 'customers' && (
                      <div>
                        <h3 className="font-semibold mb-4 text-lg flex items-center gap-2">
                          <i className="fas fa-crown text-purple-500"></i>
                          消费金额最高客户 TOP 10
                        </h3>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="bg-gray-50">
                                <th className="p-3 text-left">排名</th>
                                <th className="p-3 text-left">客户姓名</th>
                                <th className="p-3 text-left">电话号码</th>
                                <th className="p-3 text-left">订单次数</th>
                                <th className="p-3 text-left">消费总额</th>
                                <th className="p-3 text-left">平均订单金额</th>
                              </tr>
                            </thead>
                            <tbody>
                              {topCustomers.map((customer, index) => (
                                <tr key={`${customer.name}-${customer.phone}`} className="border-b hover:bg-gray-50">
                                  <td className="p-3">
                                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                                      index === 0 ? 'bg-purple-100 text-purple-800' :
                                      index === 1 ? 'bg-blue-100 text-blue-800' :
                                      index === 2 ? 'bg-green-100 text-green-800' :
                                      'bg-gray-100 text-gray-800'
                                    }`}>
                                      #{index + 1}
                                    </span>
                                  </td>
                                  <td className="p-3 font-medium">{customer.name}</td>
                                  <td className="p-3">{customer.phone}</td>
                                  <td className="p-3">{customer.orderCount}</td>
                                  <td className="p-3 font-medium text-green-600">RM{customer.totalAmount.toFixed(2)}</td>
                                  <td className="p-3">RM{(customer.totalAmount / customer.orderCount).toFixed(2)}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          {topCustomers.length === 0 && (
                            <div className="text-center py-8 text-gray-500">
                              <i className="fas fa-users text-4xl mb-2"></i>
                              <p>暂无客户数据</p>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                );
              }

              // ========= 主应用组件 =========
              function App() {
                const [currentView, setCurrentView] = useState('customer');
                const [user, setUser] = useState(null);
                const [toast, setToast] = useState(null);
                const [products, setProducts] = useState([]);
                const [cart, setCart] = useState([]);
                const [isLoading, setIsLoading] = useState(true);
                const [lastOrder, setLastOrder] = useState(null);
                
                const showToast = (message, type = 'success') => {
                  setToast({ message, type });
                  setTimeout(() => setToast(null), 3000);
                };
                
                const fetchProducts = useCallback(async () => {
                  setIsLoading(true);
                  const { data, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('is_published', true)
                    .order('id');
                    
                  if (error) {
                    showToast('加载商品失败: ' + error.message, 'danger');
                    setProducts([]);
                  } else {
                    const formattedProducts = data.map(p => {
                      let imgUrl = '';
                      if (p.image_url) {
                        imgUrl = p.image_url;
                      } else if (p.image) {
                        const rawName = String(p.image).trim();
                        imgUrl = rawName.startsWith('http') ? rawName : 
                          ('https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/' + encodeURIComponent(rawName));
                      }
                      return {
                        ...p,
                        image: imgUrl,
                        stock: p.stock_quantity ?? 0,
                        minStock: p.min_stock_threshold ?? 5
                      };
                    });
                    setProducts(formattedProducts);
                  }
                  setIsLoading(false);
                }, []);
                
                useEffect(() => {
                  fetchProducts();
                }, [fetchProducts]);
                
                const addToCart = (product) => {
                  // Check stock availability for non-preorder items (现货商品)
                  if (!product.is_unlimited) {
                    const availableStock = product.stock_quantity ?? 0;
                    const currentInCart = cart.find(item => item.id === product.id)?.quantity ?? 0;
                    
                    if (availableStock <= 0) {
                      showToast('商品已售罄', 'danger');
                      return;
                    }
                    
                    if (currentInCart >= availableStock) {
                      showToast(`库存不足，仅剩${availableStock}件`, 'danger');
                      return;
                    }
                  }
                  
                  setCart(prevCart => {
                    const existingItem = prevCart.find(item => item.id === product.id);
                    if (existingItem) {
                      // Double-check stock limit before updating
                      if (!product.is_unlimited && existingItem.quantity >= (product.stock_quantity ?? 0)) {
                        return prevCart; // Don't update if would exceed stock
                      }
                      return prevCart.map(item =>
                        item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
                      );
                    } else {
                      return [...prevCart, { ...product, quantity: 1 }];
                    }
                  });
                  showToast('商品已添加到购物车', 'success');
                };
                
                const updateCartQuantity = (productId, newQuantity) => {
                  if (newQuantity <= 0) {
                    setCart(prevCart => prevCart.filter(item => item.id !== productId));
                    return;
                  }
                  
                  setCart(prevCart =>
                    prevCart.map(item => {
                      if (item.id === productId) {
                        // Validate stock for non-preorder items (现货商品)
                        if (!item.is_unlimited) {
                          const availableStock = item.stock_quantity ?? 0;
                          if (newQuantity > availableStock) {
                            // Auto-adjust to maximum available stock
                            showToast(`数量已调整为库存上限：${availableStock}件`, 'warning');
                            return { ...item, quantity: availableStock };
                          }
                        }
                        return { ...item, quantity: newQuantity };
                      }
                      return item;
                    })
                  );
                };
                
                const removeFromCart = (productId) => {
                  setCart(prevCart => prevCart.filter(item => item.id !== productId));
                };
                
                const cartTotal = useMemo(() => {
                  return cart.reduce((total, item) => total + Number(item.price) * item.quantity, 0);
                }, [cart]);
                
                const totalItems = useMemo(() => {
                  return cart.reduce((sum, item) => sum + item.quantity, 0);
                }, [cart]);
                
                const renderView = () => {
                  switch(currentView) {
                    case 'customer':
                      return (
                        <CustomerView
                          products={products}
                          cart={cart}
                          addToCart={addToCart}
                          updateCartQuantity={updateCartQuantity}
                          removeFromCart={removeFromCart}
                          cartTotal={cartTotal}
                          totalItems={totalItems}
                          showToast={showToast}
                          refreshProducts={fetchProducts}
                          isLoading={isLoading}
                          setLastOrder={setLastOrder}
                          setCart={setCart}
                          onAdminClick={() => setCurrentView('login')}
                        />
                      );
                    case 'login':
                      return (
                        <LoginScreen
                          onLogin={(u) => { setUser(u); setCurrentView('admin'); }}
                          showToast={showToast}
                        />
                      );
                    case 'admin':
                      return (
                        <Layout
                          onLogout={() => setCurrentView('customer')}
                          currentView={currentView}
                          setCurrentView={setCurrentView}
                        />
                      );
                    default:
                      return (
                        <CustomerView
                          products={products}
                          cart={cart}
                          addToCart={addToCart}
                          updateCartQuantity={updateCartQuantity}
                          removeFromCart={removeFromCart}
                          cartTotal={cartTotal}
                          totalItems={totalItems}
                          showToast={showToast}
                          refreshProducts={fetchProducts}
                          isLoading={isLoading}
                          setLastOrder={setLastOrder}
                          setCart={setCart}
                          onAdminClick={() => setCurrentView('login')}
                        />
                      );
                  }
                };
                
                return (
                  <div className="min-h-screen bg-gray-50">
                    {isLoading && currentView === 'customer' && (
                      <LoadingOverlay text="加载中..." />
                    )}
                    {toast && (
                      <div className="fixed top-4 right-4 z-50">
                        <Toast {...toast} onDismiss={() => setToast(null)} />
                      </div>
                    )}
                    <main>
                      {lastOrder ? (
                        <OrderSuccessModal
                          order={lastOrder}
                          onNewOrder={() => {
                            setLastOrder(null);
                            fetchProducts();
                          }}
                        />
                      ) : (
                        renderView()
                      )}
                    </main>
                  </div>
                );
              }

              function Layout({ onLogout, currentView, setCurrentView }) {
                const [view, setView] = useState('dashboard');
                const [sidebarOpen, setSidebarOpen] = useState(false);
                
                return (
                  <div className="flex flex-col h-screen">
                    <header className="bg-white shadow-sm border-b px-6 py-4">
                      <div className="flex justify-between items-center">
                        <div className="flex items-center gap-3">
                          {/* Mobile menu button */}
                          <button 
                            onClick={() => setSidebarOpen(true)} 
                            className="md:hidden p-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors"
                          >
                            <i className="fas fa-bars text-xl"></i>
                          </button>
                          <i className="fas fa-utensils text-2xl text-red-600"></i>
                          <h1 className="text-xl font-bold text-gray-800">锋味派管理后台</h1>
                        </div>
                        <div className="flex items-center gap-4">
                          <button 
                            onClick={() => setCurrentView('customer')} 
                            className="px-4 py-2 text-sm rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-700 flex items-center gap-2 transition-colors"
                          >
                            <i className="fas fa-store"></i>返回客户端
                          </button>
                          <span className="text-sm text-gray-500 hidden sm:inline">管理员</span>
                          <button 
                            onClick={onLogout} 
                            className="px-4 py-2 text-sm rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors"
                          >
                            退出
                          </button>
                        </div>
                      </div>
                    </header>
                    <div className="flex flex-1 relative">
                      {/* Sidebar overlay for mobile */}
                      {sidebarOpen && (
                        <div
                          className="fixed inset-0 bg-black/50 z-40 md:hidden"
                          onClick={() => setSidebarOpen(false)}
                        />
                      )}
                      
                      {/* Sidebar */}
                      <aside className={`
                        w-64 bg-white border-r shadow-sm transition-transform duration-300 ease-in-out
                        md:relative md:translate-x-0
                        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
                        fixed md:static top-0 left-0 h-full z-50 md:z-auto
                      `}>
                        <div className="flex justify-between items-center p-4 md:hidden border-b">
                          <span className="font-bold text-gray-800">菜单</span>
                          <button 
                            onClick={() => setSidebarOpen(false)}
                            className="p-2 rounded-lg text-gray-600 hover:bg-gray-100"
                          >
                            <i className="fas fa-times"></i>
                          </button>
                        </div>
                        <nav className="p-4 space-y-2">
                          {[
                            {k:'dashboard', i:'chart-line', t:'仪表板'},
                            {k:'products', i:'pizza-slice', t:'产品管理'},
                            {k:'inventory', i:'boxes', t:'库存管理'},
                            {k:'orders', i:'list', t:'订单管理'},
                            {k:'scanner', i:'qrcode', t:'扫码功能'},
                            {k:'camera', i:'camera', t:'拍照功能'},
                            {k:'analytics', i:'chart-pie', t:'数据分析'}
                          ].map(m => (
                            <button 
                              key={m.k} 
                              onClick={() => {
                                setView(m.k);
                                setSidebarOpen(false); // Close sidebar on mobile after selection
                              }} 
                              className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors ${
                                view === m.k ? 'bg-red-100 text-red-700' : 'text-gray-600 hover:bg-gray-100'
                              }`}
                            >
                              <i className={`fas fa-${m.i} w-5`}></i>
                              <span>{m.t}</span>
                            </button>
                          ))}
                        </nav>
                      </aside>
                      
                      <main className="flex-1 p-3 md:p-6 overflow-auto bg-gray-50">
                        {view === 'dashboard' && <Dashboard setView={setView}/>}
                        {view === 'products' && <Products/>}
                        {view === 'inventory' && <Inventory/>}
                        {view === 'orders' && <Orders/>}
                        {view === 'scanner' && <Scanner/>}
                        {view === 'camera' && <Camera/>}
                        {view === 'analytics' && <Analytics/>}
                      </main>
                    </div>
                  </div>
                );
              }

              // Chrome兼容性增强：确保所有资源加载完毕
              function initializeApp() {
                // 检查必要的全局对象
                if (typeof React === 'undefined') {
                  console.error('React not loaded');
                  return;
                }
                if (typeof ReactDOM === 'undefined') {
                  console.error('ReactDOM not loaded');
                  return;
                }
                if (typeof window.supabase === 'undefined') {
                  console.error('Supabase not loaded');
                  return;
                }
                
                console.log('All dependencies loaded, initializing app...');
                console.log('App function:', typeof App, App);
                
                // Chrome兼容性增强：使用错误边界包装App
                ReactDOM.render(
                  React.createElement(ErrorBoundary, null, 
                    React.createElement(App, null)
                  ), 
                  document.getElementById('root')
                );
              }
              
              // 延迟初始化以确保资源加载
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => setTimeout(initializeApp, 100));
              } else {
                setTimeout(initializeApp, 100);
              }
            </script>
          </body>
          </html>